

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Arch Linux Root on ZFS &mdash; OpenZFS  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme_overrides.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/mandoc.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Artix Linux Root on ZFS" href="Artix Linux Root on ZFS.html" />
    <link rel="prev" title="Arch Linux" href="index.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #29667e" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/logo_main.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Getting Started</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Arch Linux</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="index.html#support">Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#installation">Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#check-live-image-compatibility">Check Live Image Compatibility</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html#root-on-zfs">Root on ZFS</a><ul class="current">
<li class="toctree-l4 current"><a class="current reference internal" href="#">Arch Linux Root on ZFS</a></li>
<li class="toctree-l4"><a class="reference internal" href="Artix Linux Root on ZFS.html">Artix Linux Root on ZFS</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../Debian/index.html">Debian</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Fedora.html">Fedora</a></li>
<li class="toctree-l2"><a class="reference internal" href="../FreeBSD.html">FreeBSD</a></li>
<li class="toctree-l2"><a class="reference external" href="https://wiki.gentoo.org/wiki/ZFS">Gentoo</a></li>
<li class="toctree-l2"><a class="reference external" href="https://nixos.wiki/wiki/NixOS_on_ZFS">NixOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../openSUSE/index.html">openSUSE</a></li>
<li class="toctree-l2"><a class="reference internal" href="../RHEL and CentOS.html">RHEL and CentOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Ubuntu/index.html">Ubuntu</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../Project and Community/index.html">Project and Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Developer Resources/index.html">Developer Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Performance and Tuning/index.html">Performance and Tuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Basic Concepts/index.html">Basic Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../man/index.html">Man Pages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../msg/index.html">ZFS Messages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../License.html">License</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">OpenZFS</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Getting Started</a> &raquo;</li>
        
          <li><a href="index.html">Arch Linux</a> &raquo;</li>
        
      <li>Arch Linux Root on ZFS</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/openzfs/openzfs-docs/blob/master/docs/Getting Started/Arch Linux/Arch Linux Root on ZFS.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="arch-linux-root-on-zfs">
<h1>Arch Linux Root on ZFS<a class="headerlink" href="#arch-linux-root-on-zfs" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#overview" id="id1">Overview</a></p>
<ul>
<li><p><a class="reference internal" href="#caution" id="id2">Caution</a></p></li>
<li><p><a class="reference internal" href="#support" id="id3">Support</a></p></li>
<li><p><a class="reference internal" href="#contributing" id="id4">Contributing</a></p></li>
<li><p><a class="reference internal" href="#encryption" id="id5">Encryption</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#preinstallation" id="id6">Preinstallation</a></p>
<ul>
<li><p><a class="reference internal" href="#download-arch-linux-live-image" id="id7">Download Arch Linux live image</a></p></li>
<li><p><a class="reference internal" href="#prepare-the-live-environment" id="id8">Prepare the Live Environment</a></p></li>
<li><p><a class="reference internal" href="#installation-variables" id="id9">Installation Variables</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#system-installation" id="id10">System Installation</a></p>
<ul>
<li><p><a class="reference internal" href="#format-and-partition-the-target-disks" id="id11">Format and Partition the Target Disks</a></p></li>
<li><p><a class="reference internal" href="#create-root-and-boot-pools" id="id12">Create Root and Boot Pools</a></p></li>
<li><p><a class="reference internal" href="#create-datasets" id="id13">Create Datasets</a></p></li>
<li><p><a class="reference internal" href="#format-and-mount-efi-system-partition" id="id14">Format and Mount EFI System Partition</a></p></li>
<li><p><a class="reference internal" href="#package-installation" id="id15">Package Installation</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#system-configuration" id="id16">System Configuration</a></p></li>
<li><p><a class="reference internal" href="#bootloader-installation" id="id17">Bootloader Installation</a></p>
<ul>
<li><p><a class="reference internal" href="#grub-probe-fails-to-get-canonical-path" id="id18">grub-probe fails to get canonical path</a></p></li>
<li><p><a class="reference internal" href="#pool-name-missing" id="id19">Pool name missing</a></p></li>
<li><p><a class="reference internal" href="#grub-installation" id="id20">GRUB Installation</a></p></li>
<li><p><a class="reference internal" href="#generate-grub-boot-menu" id="id21">Generate GRUB Boot Menu</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#optional-configuration" id="id22">Optional Configuration</a></p>
<ul>
<li><p><a class="reference internal" href="#supply-password-with-ssh" id="id23">Supply password with SSH</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#finish-installation" id="id24">Finish Installation</a></p></li>
<li><p><a class="reference internal" href="#after-reboot" id="id25">After Reboot</a></p>
<ul>
<li><p><a class="reference internal" href="#mirror-efi-system-partition" id="id26">Mirror EFI System Partition</a></p></li>
<li><p><a class="reference internal" href="#mirror-bios-boot-sector" id="id27">Mirror BIOS boot sector</a></p></li>
<li><p><a class="reference internal" href="#boot-environment-manager" id="id28">Boot Environment Manager</a></p></li>
<li><p><a class="reference internal" href="#post-installation" id="id29">Post installation</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#encrypt-boot-pool-with-luks" id="id30">Encrypt boot pool with LUKS</a></p>
<ul>
<li><p><a class="reference internal" href="#secure-boot" id="id31">Secure Boot</a></p></li>
<li><p><a class="reference internal" href="#hibernation" id="id32">Hibernation</a></p></li>
<li><p><a class="reference internal" href="#enter-luks-password-in-grub-rescue" id="id33">Enter LUKS password in GRUB rescue</a></p></li>
<li><p><a class="reference internal" href="#change-grub-prefix-when-disk-fails" id="id34">Change GRUB prefix when disk fails</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#recovery" id="id35">Recovery</a></p>
<ul>
<li><p><a class="reference internal" href="#load-grub-cfg-in-grub-command-line" id="id36">Load grub.cfg in GRUB command line</a></p></li>
<li><p><a class="reference internal" href="#rescue-in-live-environment" id="id37">Rescue in Live Environment</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="overview">
<h2><a class="toc-backref" href="#id1">Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<div class="section" id="caution">
<h3><a class="toc-backref" href="#id2">Caution</a><a class="headerlink" href="#caution" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>This guide uses entire physical disks.</p></li>
<li><p>Multiple systems on one disk is not supported.</p></li>
<li><p>Target disk will be wiped. Back up your data before continuing.</p></li>
<li><p>The target system, virtual or physical, must have at least 4GB RAM,
or the DKMS module might fail to build.</p></li>
<li><p>Installing on a drive which presents 4 KiB logical sectors (a “4Kn” drive)
only works with UEFI booting. This not unique to ZFS. <a class="reference external" href="http://savannah.gnu.org/bugs/?46700">GRUB does not and
will not work on 4Kn with legacy (BIOS) booting.</a></p></li>
</ul>
</div>
<div class="section" id="support">
<h3><a class="toc-backref" href="#id3">Support</a><a class="headerlink" href="#support" title="Permalink to this headline">¶</a></h3>
<p>If you need help, reach out to the community using the <a class="reference internal" href="../../Project and Community/Mailing Lists.html#mailing-lists"><span class="std std-ref">Mailing Lists</span></a> or IRC at
<a class="reference external" href="irc://irc.freenode.net/#zfsonlinux">#zfsonlinux</a> on <a class="reference external" href="https://freenode.net/">freenode</a>. If you have a bug report or feature request
related to this HOWTO, please <a class="reference external" href="https://github.com/openzfs/openzfs-docs/issues/new?body=&#64;ne9z,%20I%20have%20the%20following%20issue%20with%20the%20Arch%20Linux%20Root%20on%20ZFS%20HOWTO:">file a new issue and mention &#64;ne9z</a>.</p>
</div>
<div class="section" id="contributing">
<h3><a class="toc-backref" href="#id4">Contributing</a><a class="headerlink" href="#contributing" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>Fork and clone <a class="reference external" href="https://github.com/openzfs/openzfs-docs">this repo</a>.</p></li>
<li><p>Install the tools:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo pacman -S python-pip

pip3 install -r docs/requirements.txt

<span class="c1"># Add ~/.local/bin to your $PATH, e.g. by adding this to ~/.bashrc:</span>
<span class="nv">PATH</span><span class="o">=</span><span class="nv">$HOME</span>/.local/bin:<span class="nv">$PATH</span>
</pre></div>
</div>
</li>
<li><p>Make your changes.</p></li>
<li><p>Test:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> docs
make html
sensible-browser _build/html/index.html
</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">commit</span> <span class="pre">--signoff</span></code> to a branch, <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">push</span></code>, and create a pull
request. Mention &#64;rlaager.</p></li>
</ol>
</div>
<div class="section" id="encryption">
<h3><a class="toc-backref" href="#id5">Encryption</a><a class="headerlink" href="#encryption" title="Permalink to this headline">¶</a></h3>
<p>This guide supports optional ZFS native encryption on root pool.</p>
<p>Unencrypted does not encrypt anything, of course. With no encryption
happening, this option naturally has the best performance.</p>
<p>ZFS native encryption encrypts the data and most metadata in the root
pool. It does not encrypt dataset or snapshot names or properties. The
boot pool is not encrypted at all, but it only contains the bootloader,
kernel, and initrd. (Unless you put a password in <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code>, the
initrd is unlikely to contain sensitive data.) The system cannot boot
without the passphrase being entered at the console. Performance is
good. As the encryption happens in ZFS, even if multiple disks (mirror
or raidz topologies) are used, the data only has to be encrypted once.</p>
<p>Boot pool can be optionally encrypted with LUKS, see <a class="reference external" href="#encrypt-boot-pool-with-luks">here</a>.
Encrypted boot pool can protect initrd from tempering.</p>
</div>
</div>
<div class="section" id="preinstallation">
<h2><a class="toc-backref" href="#id6">Preinstallation</a><a class="headerlink" href="#preinstallation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="download-arch-linux-live-image">
<h3><a class="toc-backref" href="#id7">Download Arch Linux live image</a><a class="headerlink" href="#download-arch-linux-live-image" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>Choose a mirror</p>
<blockquote>
<div><p><a class="reference external" href="https://archlinux.org/mirrorlist/all/">Mirrorlist</a></p>
</div></blockquote>
</li>
<li><p>Download Feb 2021 build and signature. <a class="reference external" href="https://github.com/openzfs/openzfs-docs/issues/new?body=&#64;ne9z,%20Update%20Live%20Image%20Arch%20Linux%20Root%20on%20ZFS%20HOWTO:">File a new issue and mention &#64;ne9z</a> if it’s
no longer available.</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://mirrors.ocf.berkeley.edu/archlinux/iso/2021.02.01/archlinux-2021.02.01-x86_64.iso">ISO (US mirror)</a></p></li>
<li><p><a class="reference external" href="https://archlinux.org/iso/2021.02.01/archlinux-2021.02.01-x86_64.iso.sig">Signature</a></p></li>
</ul>
</div></blockquote>
</li>
<li><p>Check live image against signature:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>gpg --auto-key-retrieve --verify archlinux-2021.02.01-x86_64.iso.sig
</pre></div>
</div>
<p>If the file is authentic, output should be the following:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>gpg: Signature made Mon <span class="m">01</span> Feb <span class="m">2021</span> <span class="m">03</span>:23:39 PM UTC
gpg:                using RSA key 4AA4767BBC9C4B1D18AE28B77F2D434B9741E8AC
gpg: Good signature from <span class="s2">&quot;Pierre Schmitz &lt;pierre@archlinux.de&gt;&quot;</span> <span class="o">[</span>unknown<span class="o">]</span>
...
Primary key fingerprint: 4AA4 767B BC9C 4B1D 18AE  28B7 7F2D 434B <span class="m">9741</span> E8AC
</pre></div>
</div>
<p>Ensure <code class="docutils literal notranslate"><span class="pre">Good</span> <span class="pre">signature</span></code> and last 8 digits are <code class="docutils literal notranslate"><span class="pre">9741</span> <span class="pre">E8AC</span></code>,
as listed on <a class="reference external" href="https://archlinux.org/people/developers/#pierre">Arch Linux Developers</a> page.</p>
</li>
<li><p>Write the image to a USB drive or an optical disc.</p></li>
<li><p>Boot the target computer from the prepared live medium.</p></li>
</ol>
</div>
<div class="section" id="prepare-the-live-environment">
<h3><a class="toc-backref" href="#id8">Prepare the Live Environment</a><a class="headerlink" href="#prepare-the-live-environment" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>Connect to the internet.
If the target computer aquires IP address with DHCP,
no further steps need to be taken.
Otherwise, refer to
<a class="reference external" href="https://wiki.archlinux.org/index.php/Network_configuration">Network Configuration</a>
wiki page.</p></li>
<li><p>Start SSH server.</p>
<ul>
<li><p>Interactively set root password with:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>passwd
</pre></div>
</div>
</li>
<li><p>Start SSH server:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>systemctl start sshd
</pre></div>
</div>
</li>
<li><p>Find the IP address of the target computer:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ip -4 address show scope global
</pre></div>
</div>
</li>
<li><p>On another computer, connect to the target computer with:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ssh root@192.168.1.10
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>Enter a bash shell:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>bash
</pre></div>
</div>
</li>
<li><p>Import keys of archzfs repository:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>curl -L https://archzfs.com/archzfs.gpg <span class="p">|</span>  pacman-key -a -
curl -L https://git.io/JtQpl <span class="p">|</span> xargs -i<span class="o">{}</span> pacman-key --lsign-key <span class="o">{}</span>
</pre></div>
</div>
</li>
<li><p>Add archzfs repository:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>tee -a /etc/pacman.conf <span class="s">&lt;&lt;- &#39;EOF&#39;</span>

<span class="s">[archzfs]</span>
<span class="s">Include = /etc/pacman.d/mirrorlist-archzfs</span>
<span class="s">EOF</span>

curl -L https://git.io/JtQp4 &gt; /etc/pacman.d/mirrorlist-archzfs
</pre></div>
</div>
</li>
<li><p>Select mirror:</p>
<ul>
<li><p>Kill <code class="docutils literal notranslate"><span class="pre">reflector</span></code>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>killall -9 reflector
</pre></div>
</div>
</li>
<li><p>Edit the following files:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>nano /etc/pacman.d/mirrorlist
</pre></div>
</div>
<p>Uncomment and move mirrors to
the beginning of the file.</p>
</li>
<li><p>Update database:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>pacman -Sy
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>Install ZFS in the live environment:</p>
<p>Check kernel variant:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">LIVE_LINVAR</span><span class="o">=</span><span class="k">$(</span>sed <span class="s1">&#39;s|.*linux|linux|&#39;</span> /proc/cmdline <span class="p">|</span> sed <span class="s1">&#39;s|.img||g&#39;</span> <span class="p">|</span> awk <span class="s1">&#39;{ print $1 }&#39;</span><span class="k">)</span>
</pre></div>
</div>
<p>Check kernel version:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">LIVE_LINVER</span><span class="o">=</span><span class="k">$(</span>pacman -Qi <span class="si">${</span><span class="nv">LIVE_LINVAR</span><span class="si">}</span> <span class="p">|</span> grep Version <span class="p">|</span> awk <span class="s1">&#39;{ print $3 }&#39;</span><span class="k">)</span>
</pre></div>
</div>
<p>Install kernel headers:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>pacman -U https://archive.archlinux.org/packages/l/<span class="si">${</span><span class="nv">LIVE_LINVAR</span><span class="si">}</span>-headers/<span class="si">${</span><span class="nv">LIVE_LINVAR</span><span class="si">}</span>-headers-<span class="si">${</span><span class="nv">LIVE_LINVER</span><span class="si">}</span>-x86_64.pkg.tar.zst
</pre></div>
</div>
<p>Expand root filesystem:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mount -o remount,size<span class="o">=</span>2G /run/archiso/cowspace
</pre></div>
</div>
<p>Install zfs-dkms:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>pacman -S zfs-dkms glibc
</pre></div>
</div>
</li>
<li><p>Load kernel module:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>modprobe zfs
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="installation-variables">
<h3><a class="toc-backref" href="#id9">Installation Variables</a><a class="headerlink" href="#installation-variables" title="Permalink to this headline">¶</a></h3>
<p>In this part, we will set some variables to configure the system.</p>
<ol class="arabic">
<li><p>Timezone</p>
<p>List the available timezones with:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ls /usr/share/zoneinfo/
</pre></div>
</div>
<p>Store the target timezone in a variable:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">INST_TZ</span><span class="o">=</span>/usr/share/zoneinfo/Asia/Irkutsk
</pre></div>
</div>
</li>
<li><p>Host name</p>
<p>Store the host name in a variable:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">INST_HOST</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span>
</pre></div>
</div>
</li>
<li><p>Kernel variant</p>
<p>Store the kernel variant in a variable.
Available variants in official repo are:</p>
<ul class="simple">
<li><p>linux</p></li>
<li><p>linux-lts</p></li>
<li><p>linux-zen</p></li>
<li><p>linux-hardened</p></li>
</ul>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">INST_LINVAR</span><span class="o">=</span><span class="s1">&#39;linux&#39;</span>
</pre></div>
</div>
</li>
<li><p>Target disk</p>
<p>List the available disks with:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ls -d /dev/disk/by-id/* <span class="p">|</span> grep -v part
</pre></div>
</div>
<p>If the disk is not in the command output, use <code class="docutils literal notranslate"><span class="pre">/dev/disk/by-path</span></code>.</p>
<p>Store the target disk in a variable:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">DISK</span><span class="o">=</span>/dev/disk/by-id/nvme-foo_NVMe_bar_512GB
</pre></div>
</div>
<p>For multi-disk setups, repeat the formatting and
partitioning commands for other disks.</p>
</li>
<li><p>Create a mountpoint with:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">INST_MNT</span><span class="o">=</span><span class="k">$(</span>mktemp -d<span class="k">)</span>
</pre></div>
</div>
</li>
<li><p>To avoid name conflict when importing pools on another computer,
Give them a unique suffix:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">INST_UUID</span><span class="o">=</span><span class="k">$(</span>dd <span class="k">if</span><span class="o">=</span>/dev/urandom <span class="nv">of</span><span class="o">=</span>/dev/stdout <span class="nv">bs</span><span class="o">=</span><span class="m">1</span> <span class="nv">count</span><span class="o">=</span><span class="m">100</span> <span class="m">2</span>&gt;/dev/null <span class="p">|</span>tr -dc <span class="s1">&#39;a-z0-9&#39;</span> <span class="p">|</span> cut -c-6<span class="k">)</span>
</pre></div>
</div>
</li>
</ol>
</div>
</div>
<div class="section" id="system-installation">
<h2><a class="toc-backref" href="#id10">System Installation</a><a class="headerlink" href="#system-installation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="format-and-partition-the-target-disks">
<h3><a class="toc-backref" href="#id11">Format and Partition the Target Disks</a><a class="headerlink" href="#format-and-partition-the-target-disks" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>Clear the partition table:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sgdisk --zap-all <span class="nv">$DISK</span>
</pre></div>
</div>
</li>
<li><p>Create EFI system partition (for use now or in the future):</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sgdisk -n1:1M:+1G -t1:EF00 <span class="nv">$DISK</span>
</pre></div>
</div>
</li>
<li><p>Create BIOS boot partition:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sgdisk -a1 -n5:24K:+1000K -t5:EF02 <span class="nv">$DISK</span>
</pre></div>
</div>
</li>
<li><p>Create boot pool partition:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sgdisk -n2:0:+4G -t2:BE00 <span class="nv">$DISK</span>
</pre></div>
</div>
</li>
<li><p>Create root pool partition:</p>
<ul>
<li><p>If you don’t need a separate swap partition:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sgdisk -n3:0:0 -t3:BF00 <span class="nv">$DISK</span>
</pre></div>
</div>
</li>
<li><p>If a separate swap partition is needed:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sgdisk -n3:0:-8G -t3:BF00 <span class="nv">$DISK</span>
sgdisk -n4:0:0   -t4:8308 <span class="nv">$DISK</span>
</pre></div>
</div>
</li>
</ul>
<blockquote>
<div><p>Adjust the swap partition size to your needs.
If <a class="reference external" href="#hibernation">hibernation</a> is needed,
swap size should be same or larger than RAM.
Check RAM size with <code class="docutils literal notranslate"><span class="pre">free</span> <span class="pre">-h</span></code>.</p>
</div></blockquote>
</li>
<li><p>Repeat the above steps for other target disks, if any.</p></li>
</ol>
</div>
<div class="section" id="create-root-and-boot-pools">
<h3><a class="toc-backref" href="#id12">Create Root and Boot Pools</a><a class="headerlink" href="#create-root-and-boot-pools" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>For multi-disk setup</p>
<p>If you want to create a multi-disk pool, replace <code class="docutils literal notranslate"><span class="pre">${DISK}-partX</span></code>
with the topology and the disk path.</p>
<p>For example, change:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zpool create <span class="se">\</span>
  ... <span class="se">\</span>
  <span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>-part2
</pre></div>
</div>
<p>to:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zpool create <span class="se">\</span>
  ... <span class="se">\</span>
  mirror <span class="se">\</span>
  /dev/disk/by-id/ata-disk1-part2 <span class="se">\</span>
  /dev/disk/by-id/ata-disk2-part2
</pre></div>
</div>
<p>if needed, replace <code class="docutils literal notranslate"><span class="pre">mirror</span></code> with <code class="docutils literal notranslate"><span class="pre">raidz1</span></code>, <code class="docutils literal notranslate"><span class="pre">raidz2</span></code> or <code class="docutils literal notranslate"><span class="pre">raidz3</span></code>.</p>
</li>
<li><p>Create boot pool:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zpool create <span class="se">\</span>
    -o <span class="nv">ashift</span><span class="o">=</span><span class="m">12</span> <span class="se">\</span>
    -o <span class="nv">autotrim</span><span class="o">=</span>on <span class="se">\</span>
    -d -o feature@async_destroy<span class="o">=</span>enabled <span class="se">\</span>
    -o feature@bookmarks<span class="o">=</span>enabled <span class="se">\</span>
    -o feature@embedded_data<span class="o">=</span>enabled <span class="se">\</span>
    -o feature@empty_bpobj<span class="o">=</span>enabled <span class="se">\</span>
    -o feature@enabled_txg<span class="o">=</span>enabled <span class="se">\</span>
    -o feature@extensible_dataset<span class="o">=</span>enabled <span class="se">\</span>
    -o feature@filesystem_limits<span class="o">=</span>enabled <span class="se">\</span>
    -o feature@hole_birth<span class="o">=</span>enabled <span class="se">\</span>
    -o feature@large_blocks<span class="o">=</span>enabled <span class="se">\</span>
    -o feature@lz4_compress<span class="o">=</span>enabled <span class="se">\</span>
    -o feature@spacemap_histogram<span class="o">=</span>enabled <span class="se">\</span>
    -O <span class="nv">acltype</span><span class="o">=</span>posixacl <span class="se">\</span>
    -O <span class="nv">canmount</span><span class="o">=</span>off <span class="se">\</span>
    -O <span class="nv">compression</span><span class="o">=</span>lz4 <span class="se">\</span>
    -O <span class="nv">devices</span><span class="o">=</span>off <span class="se">\</span>
    -O <span class="nv">normalization</span><span class="o">=</span>formD <span class="se">\</span>
    -O <span class="nv">relatime</span><span class="o">=</span>on <span class="se">\</span>
    -O <span class="nv">xattr</span><span class="o">=</span>sa <span class="se">\</span>
    -O <span class="nv">mountpoint</span><span class="o">=</span>/boot <span class="se">\</span>
    -R <span class="nv">$INST_MNT</span> <span class="se">\</span>
    bpool_<span class="nv">$INST_UUID</span> <span class="se">\</span>
    <span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>-part2
</pre></div>
</div>
<p>You should not need to customize any of the options for the boot pool.</p>
<p>GRUB does not support all of the zpool features. See <code class="docutils literal notranslate"><span class="pre">spa_feature_names</span></code>
in <a class="reference external" href="http://git.savannah.gnu.org/cgit/grub.git/tree/grub-core/fs/zfs/zfs.c#n276">grub-core/fs/zfs/zfs.c</a>.
This step creates a separate boot pool for <code class="docutils literal notranslate"><span class="pre">/boot</span></code> with the features
limited to only those that GRUB supports, allowing the root pool to use
any/all features. Note that GRUB opens the pool read-only, so all
read-only compatible features are “supported” by GRUB.</p>
<p><strong>Feature Notes:</strong></p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">allocation_classes</span></code> feature should be safe to use. However, unless
one is using it (i.e. a <code class="docutils literal notranslate"><span class="pre">special</span></code> vdev), there is no point to enabling
it. It is extremely unlikely that someone would use this feature for a
boot pool. If one cares about speeding up the boot pool, it would make
more sense to put the whole pool on the faster disk rather than using it
as a <code class="docutils literal notranslate"><span class="pre">special</span></code> vdev.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">project_quota</span></code> feature has been tested and is safe to use. This
feature is extremely unlikely to matter for the boot pool.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">resilver_defer</span></code> should be safe but the boot pool is small enough
that it is unlikely to be necessary.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">spacemap_v2</span></code> feature has been tested and is safe to use. The boot
pool is small, so this does not matter in practice.</p></li>
<li><p>As a read-only compatible feature, the <code class="docutils literal notranslate"><span class="pre">userobj_accounting</span></code> feature
should be compatible in theory, but in practice, GRUB can fail with an
“invalid dnode type” error. This feature does not matter for <code class="docutils literal notranslate"><span class="pre">/boot</span></code>
anyway.</p></li>
</ul>
</li>
<li><p>Create root pool:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zpool create <span class="se">\</span>
 -o <span class="nv">ashift</span><span class="o">=</span><span class="m">12</span> <span class="se">\</span>
 -o <span class="nv">autotrim</span><span class="o">=</span>on <span class="se">\</span>
 -R <span class="nv">$INST_MNT</span> <span class="se">\</span>
 -O <span class="nv">acltype</span><span class="o">=</span>posixacl <span class="se">\</span>
 -O <span class="nv">canmount</span><span class="o">=</span>off <span class="se">\</span>
 -O <span class="nv">compression</span><span class="o">=</span>zstd <span class="se">\</span>
 -O <span class="nv">dnodesize</span><span class="o">=</span>auto <span class="se">\</span>
 -O <span class="nv">normalization</span><span class="o">=</span>formD <span class="se">\</span>
 -O <span class="nv">relatime</span><span class="o">=</span>on <span class="se">\</span>
 -O <span class="nv">xattr</span><span class="o">=</span>sa <span class="se">\</span>
 -O <span class="nv">mountpoint</span><span class="o">=</span>/ <span class="se">\</span>
 rpool_<span class="nv">$INST_UUID</span> <span class="se">\</span>
 <span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>-part3
</pre></div>
</div>
<p><strong>Notes:</strong></p>
<ul class="simple">
<li><p>The use of <code class="docutils literal notranslate"><span class="pre">ashift=12</span></code> is recommended here because many drives
today have 4 KiB (or larger) physical sectors, even though they
present 512 B logical sectors. Also, a future replacement drive may
have 4 KiB physical sectors (in which case <code class="docutils literal notranslate"><span class="pre">ashift=12</span></code> is desirable)
or 4 KiB logical sectors (in which case <code class="docutils literal notranslate"><span class="pre">ashift=12</span></code> is required).</p></li>
<li><p>Setting <code class="docutils literal notranslate"><span class="pre">-O</span> <span class="pre">acltype=posixacl</span></code> enables POSIX ACLs globally. If you
do not want this, remove that option, but later add
<code class="docutils literal notranslate"><span class="pre">-o</span> <span class="pre">acltype=posixacl</span></code> (note: lowercase “o”) to the <code class="docutils literal notranslate"><span class="pre">zfs</span> <span class="pre">create</span></code>
for <code class="docutils literal notranslate"><span class="pre">/var/log</span></code>, as <a class="reference external" href="https://askubuntu.com/questions/970886/journalctl-says-failed-to-search-journal-acl-operation-not-supported">journald requires ACLs</a></p></li>
<li><p>Setting <code class="docutils literal notranslate"><span class="pre">normalization=formD</span></code> eliminates some corner cases relating
to UTF-8 filename normalization. It also implies <code class="docutils literal notranslate"><span class="pre">utf8only=on</span></code>,
which means that only UTF-8 filenames are allowed. If you care to
support non-UTF-8 filenames, do not use this option. For a discussion
of why requiring UTF-8 filenames may be a bad idea, see <a class="reference external" href="http://utcc.utoronto.ca/~cks/space/blog/linux/ForcedUTF8Filenames">The problems
with enforced UTF-8 only filenames</a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">recordsize</span></code> is unset (leaving it at the default of 128 KiB). If you
want to tune it (e.g. <code class="docutils literal notranslate"><span class="pre">-o</span> <span class="pre">recordsize=1M</span></code>), see <a class="reference external" href="https://jrs-s.net/2019/04/03/on-zfs-recordsize/">these</a> <a class="reference external" href="http://blog.programster.org/zfs-record-size">various</a> <a class="reference external" href="https://utcc.utoronto.ca/~cks/space/blog/solaris/ZFSFileRecordsizeGrowth">blog</a>
<a class="reference external" href="https://utcc.utoronto.ca/~cks/space/blog/solaris/ZFSRecordsizeAndCompression">posts</a>.</p></li>
<li><p>Setting <code class="docutils literal notranslate"><span class="pre">relatime=on</span></code> is a middle ground between classic POSIX
<code class="docutils literal notranslate"><span class="pre">atime</span></code> behavior (with its significant performance impact) and
<code class="docutils literal notranslate"><span class="pre">atime=off</span></code> (which provides the best performance by completely
disabling atime updates). Since Linux 2.6.30, <code class="docutils literal notranslate"><span class="pre">relatime</span></code> has been
the default for other filesystems. See <a class="reference external" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/power_management_guide/relatime">RedHat’s documentation</a>
for further information.</p></li>
<li><p>Setting <code class="docutils literal notranslate"><span class="pre">xattr=sa</span></code> <a class="reference external" href="https://github.com/zfsonlinux/zfs/commit/82a37189aac955c81a59a5ecc3400475adb56355">vastly improves the performance of extended
attributes</a>.
Inside ZFS, extended attributes are used to implement POSIX ACLs.
Extended attributes can also be used by user-space applications.
<a class="reference external" href="https://en.wikipedia.org/wiki/Extended_file_attributes#Linux">They are used by some desktop GUI applications.</a>
<a class="reference external" href="https://wiki.samba.org/index.php/Setting_up_a_Share_Using_Windows_ACLs">They can be used by Samba to store Windows ACLs and DOS attributes;
they are required for a Samba Active Directory domain controller.</a>
Note that <code class="docutils literal notranslate"><span class="pre">xattr=sa</span></code> is <a class="reference external" href="https://openzfs.org/wiki/Platform_code_differences">Linux-specific</a>. If you move your
<code class="docutils literal notranslate"><span class="pre">xattr=sa</span></code> pool to another OpenZFS implementation besides ZFS-on-Linux,
extended attributes will not be readable (though your data will be). If
portability of extended attributes is important to you, omit the
<code class="docutils literal notranslate"><span class="pre">-O</span> <span class="pre">xattr=sa</span></code> above. Even if you do not want <code class="docutils literal notranslate"><span class="pre">xattr=sa</span></code> for the whole
pool, it is probably fine to use it for <code class="docutils literal notranslate"><span class="pre">/var/log</span></code>.</p></li>
<li><p>Make sure to include the <code class="docutils literal notranslate"><span class="pre">-part3</span></code> portion of the drive path. If you
forget that, you are specifying the whole disk, which ZFS will then
re-partition, and you will lose the bootloader partition(s).</p></li>
<li><p>ZFS native encryption <a class="reference external" href="https://github.com/openzfs/zfs/commit/31b160f0a6c673c8f926233af2ed6d5354808393">now</a>
defaults to <code class="docutils literal notranslate"><span class="pre">aes-256-gcm</span></code>.</p></li>
<li><p>Your passphrase will likely be the weakest link. Choose wisely. See
<a class="reference external" href="https://gitlab.com/cryptsetup/cryptsetup/wikis/FrequentlyAskedQuestions#5-security-aspects">section 5 of the cryptsetup FAQ</a>
for guidance.</p></li>
</ul>
</li>
</ol>
</div>
<div class="section" id="create-datasets">
<h3><a class="toc-backref" href="#id13">Create Datasets</a><a class="headerlink" href="#create-datasets" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>Create system boot container:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs create <span class="se">\</span>
 -o <span class="nv">canmount</span><span class="o">=</span>off <span class="se">\</span>
 -o <span class="nv">mountpoint</span><span class="o">=</span>/boot <span class="se">\</span>
 bpool_<span class="nv">$INST_UUID</span>/sys
</pre></div>
</div>
</li>
<li><p>Create system root container:</p>
<p>Dataset encryption is set at creation and can not be altered later,
but encrypted dataset can be created inside an unencrypted parent dataset.</p>
<ul>
<li><p>Unencrypted:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs create <span class="se">\</span>
 -o <span class="nv">canmount</span><span class="o">=</span>off <span class="se">\</span>
 -o <span class="nv">mountpoint</span><span class="o">=</span>/ <span class="se">\</span>
 rpool_<span class="nv">$INST_UUID</span>/sys
</pre></div>
</div>
</li>
<li><p>Encrypted:</p>
<ol class="arabic">
<li><p>Choose a strong password.</p>
<p>Once the password is compromised,
dataset and pool must be destroyed,
disk wiped and system rebuilt from scratch to protect confidentiality.
<a class="reference external" href="https://openzfs.github.io/openzfs-docs/man/8/zfs-change-key.8.html">Merely changing password is not enough</a>.</p>
<p>Example: generate passphrase with <a class="reference external" href="https://github.com/redacted/XKCD-password-generator">xkcdpass</a>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>pacman -S --noconfirm xkcdpass
xkcdpass -Vn <span class="m">10</span> -w /usr/lib/python*/site-packages/xkcdpass/static/eff-long
</pre></div>
</div>
<p>Password can be supplied with SSH at boot time,
see <a class="reference external" href="#supply-password-with-ssh">Supply password with SSH</a>.</p>
</li>
<li><p>Create dataset:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs create <span class="se">\</span>
 -o <span class="nv">canmount</span><span class="o">=</span>off <span class="se">\</span>
 -o <span class="nv">mountpoint</span><span class="o">=</span>/ <span class="se">\</span>
 -o <span class="nv">encryption</span><span class="o">=</span>on <span class="se">\</span>
 -o <span class="nv">keylocation</span><span class="o">=</span>prompt <span class="se">\</span>
 -o <span class="nv">keyformat</span><span class="o">=</span>passphrase <span class="se">\</span>
 rpool_<span class="nv">$INST_UUID</span>/sys
</pre></div>
</div>
</li>
</ol>
</li>
</ul>
</li>
<li><p>Create container datasets:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs create -o <span class="nv">canmount</span><span class="o">=</span>off -o <span class="nv">mountpoint</span><span class="o">=</span>none bpool_<span class="nv">$INST_UUID</span>/sys/BOOT
zfs create -o <span class="nv">canmount</span><span class="o">=</span>off -o <span class="nv">mountpoint</span><span class="o">=</span>none rpool_<span class="nv">$INST_UUID</span>/sys/ROOT
zfs create -o <span class="nv">canmount</span><span class="o">=</span>off -o <span class="nv">mountpoint</span><span class="o">=</span>none rpool_<span class="nv">$INST_UUID</span>/sys/DATA
</pre></div>
</div>
</li>
<li><p>Create root and boot filesystem datasets:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs create -o <span class="nv">mountpoint</span><span class="o">=</span>legacy -o <span class="nv">canmount</span><span class="o">=</span>noauto bpool_<span class="nv">$INST_UUID</span>/sys/BOOT/default
zfs create -o <span class="nv">mountpoint</span><span class="o">=</span>/      -o <span class="nv">canmount</span><span class="o">=</span>noauto rpool_<span class="nv">$INST_UUID</span>/sys/ROOT/default
</pre></div>
</div>
</li>
<li><p>Mount root and boot filesystem datasets:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs mount rpool_<span class="nv">$INST_UUID</span>/sys/ROOT/default
mkdir <span class="nv">$INST_MNT</span>/boot
mount -t zfs bpool_<span class="nv">$INST_UUID</span>/sys/BOOT/default <span class="nv">$INST_MNT</span>/boot
</pre></div>
</div>
</li>
<li><p>Create datasets to separate user data from root filesystem:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs create -o <span class="nv">mountpoint</span><span class="o">=</span>/ -o <span class="nv">canmount</span><span class="o">=</span>off rpool_<span class="nv">$INST_UUID</span>/sys/DATA/default

<span class="k">for</span> i in <span class="o">{</span>usr,var,var/lib<span class="o">}</span><span class="p">;</span>
<span class="k">do</span>
    zfs create -o <span class="nv">canmount</span><span class="o">=</span>off rpool_<span class="nv">$INST_UUID</span>/sys/DATA/default/<span class="nv">$i</span>
<span class="k">done</span>

<span class="k">for</span> i in <span class="o">{</span>home,root,srv,usr/local,var/log,var/spool,var/tmp<span class="o">}</span><span class="p">;</span>
<span class="k">do</span>
    zfs create -o <span class="nv">canmount</span><span class="o">=</span>on rpool_<span class="nv">$INST_UUID</span>/sys/DATA/default/<span class="nv">$i</span>
<span class="k">done</span>

chmod <span class="m">750</span> <span class="nv">$INST_MNT</span>/root
chmod <span class="m">1777</span> <span class="nv">$INST_MNT</span>/var/tmp
</pre></div>
</div>
</li>
<li><p>Optional user data datasets:</p>
<p>If this system will have games installed:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs create -o <span class="nv">canmount</span><span class="o">=</span>on rpool_<span class="nv">$INST_UUID</span>/sys/DATA/default/var/games
</pre></div>
</div>
<p>If you use /var/www on this system:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs create -o <span class="nv">canmount</span><span class="o">=</span>on rpool_<span class="nv">$INST_UUID</span>/sys/DATA/default/var/www
</pre></div>
</div>
<p>If this system will use GNOME:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs create -o <span class="nv">canmount</span><span class="o">=</span>on rpool_<span class="nv">$INST_UUID</span>/sys/DATA/default/var/lib/AccountsService
</pre></div>
</div>
<p>If this system will use Docker (which manages its own datasets &amp;
snapshots):</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs create -o <span class="nv">canmount</span><span class="o">=</span>on rpool_<span class="nv">$INST_UUID</span>/sys/DATA/default/var/lib/docker
</pre></div>
</div>
<p>If this system will use NFS (locking):</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs create -o <span class="nv">canmount</span><span class="o">=</span>on rpool_<span class="nv">$INST_UUID</span>/sys/DATA/default/var/lib/nfs
</pre></div>
</div>
<p>If this system will use Linux Containers:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs create -o <span class="nv">canmount</span><span class="o">=</span>on rpool_<span class="nv">$INST_UUID</span>/sys/DATA/default/var/lib/lxc
</pre></div>
</div>
<p>If this system will use libvirt:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs create -o <span class="nv">canmount</span><span class="o">=</span>on rpool_<span class="nv">$INST_UUID</span>/sys/DATA/default/var/lib/libvirt
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="format-and-mount-efi-system-partition">
<h3><a class="toc-backref" href="#id14">Format and Mount EFI System Partition</a><a class="headerlink" href="#format-and-mount-efi-system-partition" title="Permalink to this headline">¶</a></h3>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mkfs.vfat -n EFI <span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>-part1
mkdir <span class="nv">$INST_MNT</span>/boot/efi
mount -t vfat <span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>-part1 <span class="nv">$INST_MNT</span>/boot/efi
</pre></div>
</div>
<p>If you are using a multi-disk setup, this step will only install
bootloader to the first disk. Other disks will be handled later.</p>
</div>
<div class="section" id="package-installation">
<h3><a class="toc-backref" href="#id15">Package Installation</a><a class="headerlink" href="#package-installation" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>Install base packages:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>pacstrap <span class="nv">$INST_MNT</span> base vi mandoc grub
</pre></div>
</div>
</li>
<li><p>Check compatible kernel version:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">INST_LINVER</span><span class="o">=</span><span class="k">$(</span>pacman -Si zfs-<span class="si">${</span><span class="nv">INST_LINVAR</span><span class="si">}</span> <span class="se">\</span>
<span class="p">|</span> grep <span class="s1">&#39;Depends On&#39;</span> <span class="se">\</span>
<span class="p">|</span> sed <span class="s2">&quot;s|.*</span><span class="si">${</span><span class="nv">INST_LINVAR</span><span class="si">}</span><span class="s2">=||&quot;</span> <span class="se">\</span>
<span class="p">|</span> awk <span class="s1">&#39;{ print $1 }&#39;</span><span class="k">)</span>
</pre></div>
</div>
</li>
<li><p>Install kernel. Download from archive if kernel is not available:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="o">[</span> <span class="si">${</span><span class="nv">INST_LINVER</span><span class="si">}</span> <span class="o">==</span> <span class="se">\</span>
<span class="k">$(</span>pacman -Si <span class="si">${</span><span class="nv">INST_LINVAR</span><span class="si">}</span> <span class="p">|</span> grep Version <span class="p">|</span> awk <span class="s1">&#39;{ print $3 }&#39;</span><span class="k">)</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
 pacstrap <span class="nv">$INST_MNT</span> <span class="si">${</span><span class="nv">INST_LINVAR</span><span class="si">}</span>
<span class="k">else</span>
 pacstrap -U <span class="nv">$INST_MNT</span> <span class="se">\</span>
 https://archive.archlinux.org/packages/l/<span class="si">${</span><span class="nv">INST_LINVAR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">INST_LINVAR</span><span class="si">}</span>-<span class="si">${</span><span class="nv">INST_LINVER</span><span class="si">}</span>-x86_64.pkg.tar.zst
<span class="k">fi</span>
</pre></div>
</div>
</li>
<li><p>Install archzfs package:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>pacstrap <span class="nv">$INST_MNT</span> zfs-<span class="nv">$INST_LINVAR</span>
</pre></div>
</div>
</li>
<li><p>Install firmware:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>pacstrap <span class="nv">$INST_MNT</span> linux-firmware intel-ucode amd-ucode
</pre></div>
</div>
</li>
<li><p>If you boot your computer with EFI:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>pacstrap <span class="nv">$INST_MNT</span> efibootmgr
</pre></div>
</div>
</li>
<li><p>For other optional packages,
see <a class="reference external" href="https://wiki.archlinux.org/index.php/Installation_guide#Installation">ArchWiki</a>.</p></li>
</ol>
</div>
</div>
<div class="section" id="system-configuration">
<h2><a class="toc-backref" href="#id16">System Configuration</a><a class="headerlink" href="#system-configuration" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p>Generate list of datasets for <code class="docutils literal notranslate"><span class="pre">zfs-mount-generator</span></code> to mount them at boot:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># tab-separated zfs properties</span>
<span class="c1"># see /etc/zfs/zed.d/history_event-zfs-list-cacher.sh</span>
<span class="nb">export</span> <span class="se">\</span>
<span class="nv">PROPS</span><span class="o">=</span><span class="s2">&quot;name,mountpoint,canmount,atime,relatime,devices,exec\</span>
<span class="s2">,readonly,setuid,nbmand,encroot,keylocation\</span>
<span class="s2">,org.openzfs.systemd:requires,org.openzfs.systemd:requires-mounts-for\</span>
<span class="s2">,org.openzfs.systemd:before,org.openzfs.systemd:after\</span>
<span class="s2">,org.openzfs.systemd:wanted-by,org.openzfs.systemd:required-by\</span>
<span class="s2">,org.openzfs.systemd:nofail,org.openzfs.systemd:ignore&quot;</span>

mkdir -p <span class="nv">$INST_MNT</span>/etc/zfs/zfs-list.cache

zfs list -H -t filesystem -o <span class="nv">$PROPS</span> -r rpool_<span class="nv">$INST_UUID</span> &gt; <span class="nv">$INST_MNT</span>/etc/zfs/zfs-list.cache/rpool_<span class="nv">$INST_UUID</span>

sed -Ei <span class="s2">&quot;s|</span><span class="nv">$INST_MNT</span><span class="s2">/?|/|&quot;</span> <span class="nv">$INST_MNT</span>/etc/zfs/zfs-list.cache/*
</pre></div>
</div>
</li>
<li><p>Generate fstab:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> bpool_<span class="nv">$INST_UUID</span>/sys/BOOT/default /boot zfs rw,xattr,posixacl <span class="m">0</span> <span class="m">0</span> &gt;&gt; <span class="nv">$INST_MNT</span>/etc/fstab
<span class="nb">echo</span> <span class="nv">UUID</span><span class="o">=</span><span class="k">$(</span>blkid -s UUID -o value <span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>-part1<span class="k">)</span> /boot/efi vfat <span class="se">\</span>
x-systemd.idle-timeout<span class="o">=</span>1min,x-systemd.automount,noauto,umask<span class="o">=</span><span class="m">0022</span>,fmask<span class="o">=</span><span class="m">0022</span>,dmask<span class="o">=</span><span class="m">0022</span> <span class="m">0</span> <span class="m">1</span> &gt;&gt; <span class="nv">$INST_MNT</span>/etc/fstab
</pre></div>
</div>
<p>If a swap partition has been created:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> crypt-swap <span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>-part4 /dev/urandom swap,cipher<span class="o">=</span>aes-cbc-essiv:sha256,size<span class="o">=</span><span class="m">256</span>,discard &gt;&gt; <span class="nv">$INST_MNT</span>/etc/crypttab
<span class="nb">echo</span> /dev/mapper/crypt-swap none swap defaults <span class="m">0</span> <span class="m">0</span> &gt;&gt; <span class="nv">$INST_MNT</span>/etc/fstab
</pre></div>
</div>
</li>
<li><p>Configure mkinitcpio:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mv <span class="nv">$INST_MNT</span>/etc/mkinitcpio.conf <span class="nv">$INST_MNT</span>/etc/mkinitcpio.conf.original

tee <span class="nv">$INST_MNT</span>/etc/mkinitcpio.conf <span class="s">&lt;&lt;EOF</span>
<span class="s">HOOKS=(base udev autodetect modconf block keyboard zfs filesystems)</span>
<span class="s">EOF</span>
</pre></div>
</div>
</li>
<li><p>Host name:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="nv">$INST_HOST</span> &gt; <span class="nv">$INST_MNT</span>/etc/hostname
</pre></div>
</div>
</li>
<li><p>Configure the network interface:</p>
<p>Find the interface name:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ip link
</pre></div>
</div>
<p>Store it in a variable:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">INET</span><span class="o">=</span>enp1s0
</pre></div>
</div>
<p>Create network configuration:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>tee <span class="nv">$INST_MNT</span>/etc/systemd/network/20-default.network <span class="s">&lt;&lt;EOF</span>

<span class="s">[Match]</span>
<span class="s">Name=$INET</span>

<span class="s">[Network]</span>
<span class="s">DHCP=yes</span>
<span class="s">EOF</span>
</pre></div>
</div>
<p>Customize this file if the system is not a DHCP client.
See <a class="reference external" href="https://wiki.archlinux.org/index.php/Network_configuration">Network Configuration</a>.</p>
</li>
<li><p>Timezone:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ln -sf <span class="nv">$INST_TZ</span> <span class="nv">$INST_MNT</span>/etc/localtime
hwclock --systohc
</pre></div>
</div>
</li>
<li><p>Locale:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s2">&quot;en_US.UTF-8 UTF-8&quot;</span> &gt;&gt; <span class="nv">$INST_MNT</span>/etc/locale.gen
<span class="nb">echo</span> <span class="s2">&quot;LANG=en_US.UTF-8&quot;</span> &gt;&gt; <span class="nv">$INST_MNT</span>/etc/locale.conf
</pre></div>
</div>
<p>Other locales should be added after reboot.</p>
</li>
<li><p>Chroot:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>arch-chroot <span class="nv">$INST_MNT</span> /usr/bin/env <span class="nv">DISK</span><span class="o">=</span><span class="nv">$DISK</span> <span class="nv">INST_UUID</span><span class="o">=</span><span class="nv">$INST_UUID</span> bash --login
</pre></div>
</div>
</li>
<li><p>Apply locales:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>locale-gen
</pre></div>
</div>
</li>
<li><p>Import keys of archzfs repository:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>curl -L https://archzfs.com/archzfs.gpg <span class="p">|</span>  pacman-key -a -
curl -L https://git.io/JtQpl <span class="p">|</span> xargs -i<span class="o">{}</span> pacman-key --lsign-key <span class="o">{}</span>
</pre></div>
</div>
</li>
<li><p>Add archzfs repository:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>tee -a /etc/pacman.conf <span class="s">&lt;&lt;- &#39;EOF&#39;</span>

<span class="s">[archzfs]</span>
<span class="s">Include = /etc/pacman.d/mirrorlist-archzfs</span>
<span class="s">EOF</span>

curl -L https://git.io/JtQp4 &gt; /etc/pacman.d/mirrorlist-archzfs
</pre></div>
</div>
</li>
<li><p>Enable networking:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>systemctl <span class="nb">enable</span> systemd-networkd systemd-resolved
</pre></div>
</div>
</li>
<li><p>Enable ZFS services:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>systemctl <span class="nb">enable</span> zfs-import-cache zfs-import.target zfs-mount zfs-zed zfs.target
</pre></div>
</div>
</li>
<li><p>Generate zpool.cache</p>
<p>Pools are imported by initramfs with the information stored in <code class="docutils literal notranslate"><span class="pre">/etc/zfs/zpool.cache</span></code>.
This cache file will be embedded in initramfs.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zpool <span class="nb">set</span> <span class="nv">cachefile</span><span class="o">=</span>/etc/zfs/zpool.cache rpool_<span class="nv">$INST_UUID</span>
zpool <span class="nb">set</span> <span class="nv">cachefile</span><span class="o">=</span>/etc/zfs/zpool.cache bpool_<span class="nv">$INST_UUID</span>
</pre></div>
</div>
</li>
<li><p>Set root password:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>passwd
</pre></div>
</div>
</li>
<li><p>Generate initramfs:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mkinitcpio -P
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="bootloader-installation">
<h2><a class="toc-backref" href="#id17">Bootloader Installation</a><a class="headerlink" href="#bootloader-installation" title="Permalink to this headline">¶</a></h2>
<p>Currently GRUB has multiple compatibility problems with ZFS,
especially with regards to newer ZFS features.
Workarounds have to be applied.</p>
<div class="section" id="grub-probe-fails-to-get-canonical-path">
<h3><a class="toc-backref" href="#id18">grub-probe fails to get canonical path</a><a class="headerlink" href="#grub-probe-fails-to-get-canonical-path" title="Permalink to this headline">¶</a></h3>
<p>When persistent device names <code class="docutils literal notranslate"><span class="pre">/dev/disk/by-id/*</span></code> are used
with ZFS, GRUB will fail to resolve the path of the boot pool
device. Error:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># /usr/bin/grub-probe: error: failed to get canonical path of `/dev/virtio-pci-0000:06:00.0-part3&#39;.</span>
</pre></div>
</div>
<p>Solution:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s1">&#39;export ZPOOL_VDEV_NAME_PATH=YES&#39;</span> &gt;&gt; /etc/profile
<span class="nb">source</span> /etc/profile
</pre></div>
</div>
</div>
<div class="section" id="pool-name-missing">
<h3><a class="toc-backref" href="#id19">Pool name missing</a><a class="headerlink" href="#pool-name-missing" title="Permalink to this headline">¶</a></h3>
<p>See <a class="reference external" href="https://savannah.gnu.org/bugs/?59614">this bug report</a>.
Root pool name is missing from <code class="docutils literal notranslate"><span class="pre">root=ZFS=rpool/ROOT/default</span></code>
in generated <code class="docutils literal notranslate"><span class="pre">grub.cfg</span></code> file.</p>
<p>A workaround is to replace the pool name detection with <code class="docutils literal notranslate"><span class="pre">zdb</span></code>
command:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sed -i <span class="s2">&quot;s|rpool=.*|rpool=\`zdb -l \${GRUB_DEVICE} \| grep -E &#39;[[:blank:]]name&#39; \| cut -d\\\&#39; -f 2\`|&quot;</span>  /etc/grub.d/10_linux
</pre></div>
</div>
<p>If you forgot to apply this workaround and
followed this guide to use <code class="docutils literal notranslate"><span class="pre">rpool_$INST_UUID</span></code> and <code class="docutils literal notranslate"><span class="pre">bpool_$INST_UUID</span></code>,
<code class="docutils literal notranslate"><span class="pre">$INST_UUID</span></code> can be found out with <a class="reference internal" href="#load-grub-cfg-in-grub-command-line">Load grub.cfg in GRUB command line</a>.</p>
</div>
<div class="section" id="grub-installation">
<h3><a class="toc-backref" href="#id20">GRUB Installation</a><a class="headerlink" href="#grub-installation" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p>If you use EFI:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>grub-install
</pre></div>
</div>
<p>This will only install boot loader to $DISK.
If you use multi-disk setup, other disks are
dealt with later.</p>
<p>Some motherboards does not properly recognize GRUB
boot entry, to ensure that your computer will
boot, also install GRUB to fallback location with:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>grub-install --removable
</pre></div>
</div>
</li>
<li><p>If you use BIOS booting:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>grub-install <span class="nv">$DISK</span>
</pre></div>
</div>
<p>If this is a multi-disk setup,
install to other disks as well:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> i in <span class="o">{</span>target_disk2,target_disk3<span class="o">}</span><span class="p">;</span> <span class="k">do</span>
  grub-install /dev/disk/by-id/<span class="nv">$i</span>
<span class="k">done</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="generate-grub-boot-menu">
<h3><a class="toc-backref" href="#id21">Generate GRUB Boot Menu</a><a class="headerlink" href="#generate-grub-boot-menu" title="Permalink to this headline">¶</a></h3>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>grub-mkconfig -o /boot/grub/grub.cfg
</pre></div>
</div>
</div>
</div>
<div class="section" id="optional-configuration">
<h2><a class="toc-backref" href="#id22">Optional Configuration</a><a class="headerlink" href="#optional-configuration" title="Permalink to this headline">¶</a></h2>
<div class="section" id="supply-password-with-ssh">
<h3><a class="toc-backref" href="#id23">Supply password with SSH</a><a class="headerlink" href="#supply-password-with-ssh" title="Permalink to this headline">¶</a></h3>
<p>Optional:</p>
<ol class="arabic">
<li><p>Install mkinitcpio tools:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>pacman -S mkinitcpio-netconf mkinitcpio-dropbear openssh
</pre></div>
</div>
</li>
<li><p>Store public keys in <code class="docutils literal notranslate"><span class="pre">/etc/dropbear/root_key</span></code>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>vi /etc/dropbear/root_key
</pre></div>
</div>
<p>Note that dropbear only supports RSA keys.</p>
</li>
<li><p>Edit mkinitcpio:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>tee /etc/mkinitcpio.conf <span class="s">&lt;&lt;- &#39;EOF&#39;</span>
<span class="s">HOOKS=(base udev autodetect modconf block keyboard netconf dropbear zfsencryptssh zfs filesystems)</span>
<span class="s">EOF</span>
</pre></div>
</div>
</li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">ip=</span></code> to kernel command line:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># example DHCP</span>
<span class="nb">echo</span> <span class="s1">&#39;GRUB_CMDLINE_LINUX=&quot;ip=::::::dhcp&quot;&#39;</span> &gt;&gt; /etc/default/grub
</pre></div>
</div>
<p>Details for <code class="docutils literal notranslate"><span class="pre">ip=</span></code> can be found at
<a class="reference external" href="https://www.kernel.org/doc/html/latest/admin-guide/nfs/nfsroot.html#kernel-command-line">here</a>.</p>
</li>
<li><p>Generate host keys:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ssh-keygen -Am pem
</pre></div>
</div>
</li>
<li><p>Regenerate initramfs:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mkinitcpio -P
</pre></div>
</div>
</li>
<li><p>Update GRUB menu:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>grub-mkconfig -o /boot/grub/grub.cfg
</pre></div>
</div>
</li>
</ol>
</div>
</div>
<div class="section" id="finish-installation">
<h2><a class="toc-backref" href="#id24">Finish Installation</a><a class="headerlink" href="#finish-installation" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p>Exit chroot:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">exit</span>
</pre></div>
</div>
</li>
<li><p>Take a snapshot of the clean installation for future use:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs snapshot -r rpool_<span class="nv">$INST_UUID</span>/sys/ROOT/default@install
zfs snapshot -r bpool_<span class="nv">$INST_UUID</span>/sys/BOOT/default@install
</pre></div>
</div>
</li>
<li><p>Unmount EFI system partition:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>umount <span class="nv">$INST_MNT</span>/boot/efi
</pre></div>
</div>
</li>
<li><p>Export pools:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zpool <span class="nb">export</span> bpool_<span class="nv">$INST_UUID</span>
zpool <span class="nb">export</span> rpool_<span class="nv">$INST_UUID</span>
</pre></div>
</div>
</li>
</ol>
<blockquote>
<div><p>They must be exported, or else they will fail to be imported on reboot.</p>
</div></blockquote>
</div>
<div class="section" id="after-reboot">
<h2><a class="toc-backref" href="#id25">After Reboot</a><a class="headerlink" href="#after-reboot" title="Permalink to this headline">¶</a></h2>
<div class="section" id="mirror-efi-system-partition">
<h3><a class="toc-backref" href="#id26">Mirror EFI System Partition</a><a class="headerlink" href="#mirror-efi-system-partition" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>Check disk name:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ls -1 /dev/disk/by-id/ <span class="p">|</span> grep -v <span class="s1">&#39;\-part[0-9]&#39;</span>
</pre></div>
</div>
</li>
<li><p>Mirror EFI ssystem partition:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> i in <span class="o">{</span>target_disk2,target_disk3<span class="o">}</span><span class="p">;</span> <span class="k">do</span>
 mkfs.vfat /dev/disk/by-id/<span class="nv">$i</span>-part1
 mkdir -p /boot/efis/<span class="nv">$i</span>
 <span class="nb">echo</span> <span class="nv">UUID</span><span class="o">=</span><span class="k">$(</span>blkid -s UUID -o value /dev/disk/by-id/<span class="nv">$i</span>-part1<span class="k">)</span> /boot/efis/<span class="nv">$i</span> vfat <span class="se">\</span>
 x-systemd.idle-timeout<span class="o">=</span>1min,x-systemd.automount,noauto,umask<span class="o">=</span><span class="m">0022</span>,fmask<span class="o">=</span><span class="m">0022</span>,dmask<span class="o">=</span><span class="m">0022</span> <span class="se">\</span>
 <span class="m">0</span> <span class="m">1</span> &gt;&gt; /etc/fstab
 mount /boot/efis/<span class="nv">$i</span>
 cp -r /boot/efi/EFI/ /boot/efis/<span class="nv">$i</span>
 efibootmgr -cgp <span class="m">1</span> -l <span class="s2">&quot;\EFI\arch\grubx64.efi&quot;</span> <span class="se">\</span>
 -L <span class="s2">&quot;arch-</span><span class="nv">$i</span><span class="s2">&quot;</span> -d /dev/disk/by-id/<span class="nv">$i</span>-part1
<span class="k">done</span>
</pre></div>
</div>
</li>
<li><p>Create a service to monitor and sync EFI partitions:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>tee /etc/systemd/system/efis-sync.path <span class="s">&lt;&lt; EOF</span>
<span class="s">[Unit]</span>
<span class="s">Description=Monitor changes in EFI system partition</span>

<span class="s">[Path]</span>
<span class="s">PathChanged=/boot/efi/EFI/arch/</span>
<span class="s">#PathChanged=/boot/efi/EFI/BOOT/</span>
<span class="s">[Install]</span>
<span class="s">WantedBy=multi-user.target</span>
<span class="s">EOF</span>

tee /etc/systemd/system/efis-sync.service <span class="s">&lt;&lt; EOF</span>
<span class="s">[Unit]</span>
<span class="s">Description=Sync EFI system partition contents to backups</span>

<span class="s">[Service]</span>
<span class="s">Type=oneshot</span>
<span class="s">ExecStart=/usr/bin/bash -c &#39;for i in /boot/efis/*; do /usr/bin/cp -r /boot/efi/EFI/ $i/; done&#39;</span>
<span class="s">EOF</span>

systemctl <span class="nb">enable</span> --now efis-sync.path
</pre></div>
</div>
</li>
<li><p>If EFI system partition failed, promote one backup
to <code class="docutils literal notranslate"><span class="pre">/boot/efi</span></code> by editing <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code>.</p></li>
</ol>
</div>
<div class="section" id="mirror-bios-boot-sector">
<h3><a class="toc-backref" href="#id27">Mirror BIOS boot sector</a><a class="headerlink" href="#mirror-bios-boot-sector" title="Permalink to this headline">¶</a></h3>
<p>This need to be manually applied when GRUB is updated.</p>
<ol class="arabic">
<li><p>Check disk name:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ls -1 /dev/disk/by-id/ <span class="p">|</span> grep -v <span class="s1">&#39;\-part[0-9]&#39;</span>
</pre></div>
</div>
</li>
<li><p>Install GRUB to every disk:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> i in <span class="o">{</span>target_disk2,target_disk3<span class="o">}</span><span class="p">;</span> <span class="k">do</span>
  grub-install /dev/disk/by-id/<span class="nv">$i</span>
<span class="k">done</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="boot-environment-manager">
<h3><a class="toc-backref" href="#id28">Boot Environment Manager</a><a class="headerlink" href="#boot-environment-manager" title="Permalink to this headline">¶</a></h3>
<p>Optional: install
<a class="reference external" href="https://gitlab.com/m_zhou/rozb3-pac/-/releases">rozb3-pac</a>
pacman hook and
<a class="reference external" href="https://gitlab.com/m_zhou/bieaz/-/releases">bieaz</a>
from AUR to create boot environments.</p>
<p>Prebuilt packages are also available
in the links above.</p>
</div>
<div class="section" id="post-installation">
<h3><a class="toc-backref" href="#id29">Post installation</a><a class="headerlink" href="#post-installation" title="Permalink to this headline">¶</a></h3>
<p>For post installation recommendations,
see <a class="reference external" href="https://wiki.archlinux.org/index.php/Installation_guide#Post-installation">ArchWiki</a>.</p>
<p>Remember to create separate datasets for individual users.</p>
</div>
</div>
<div class="section" id="encrypt-boot-pool-with-luks">
<h2><a class="toc-backref" href="#id30">Encrypt boot pool with LUKS</a><a class="headerlink" href="#encrypt-boot-pool-with-luks" title="Permalink to this headline">¶</a></h2>
<p>If encryption is enabled earlier, boot pool can be optionally encrypted.</p>
<p>This step will rebuild boot pool
on a LUKS 1 container. Password must
be entered interactively at GRUB and thus incompatible with
<a class="reference external" href="#supply-password-with-ssh">Supply password with SSH</a>.</p>
<p>Encrypted boot pool protects initramfs from
malicious modification and supports hibernation
to encrypted swap.</p>
<ol class="arabic">
<li><p>Create encryption keys:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mkdir /etc/cryptkey.d/
chmod <span class="m">700</span> /etc/cryptkey.d/
dd <span class="nv">bs</span><span class="o">=</span><span class="m">32</span> <span class="nv">count</span><span class="o">=</span><span class="m">1</span> <span class="k">if</span><span class="o">=</span>/dev/urandom <span class="nv">of</span><span class="o">=</span>/etc/cryptkey.d/lukskey-bpool_<span class="nv">$INST_UUID</span>
dd <span class="nv">bs</span><span class="o">=</span><span class="m">32</span> <span class="nv">count</span><span class="o">=</span><span class="m">1</span> <span class="k">if</span><span class="o">=</span>/dev/urandom <span class="nv">of</span><span class="o">=</span>/etc/cryptkey.d/zfskey-rpool_<span class="nv">$INST_UUID</span>
</pre></div>
</div>
</li>
<li><p>Backup boot pool:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs snapshot -r bpool_<span class="nv">$INST_UUID</span>/sys@pre-luks
zfs send -R bpool_<span class="nv">$INST_UUID</span>/sys@pre-luks &gt; /root/bpool_<span class="nv">$INST_UUID</span>-pre-luks
</pre></div>
</div>
</li>
<li><p>Check boot pool creation command:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zpool <span class="nb">history</span> bpool_<span class="nv">$INST_UUID</span> <span class="p">|</span> head -n2 <span class="se">\</span>
<span class="p">|</span> grep <span class="s1">&#39;zpool create&#39;</span> &gt; /root/bpool_<span class="nv">$INST_UUID</span>-cmd
</pre></div>
</div>
<p>Note the vdev disks at the end of the command.</p>
</li>
<li><p>Unmount EFI partition:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>umount /boot/efi
umount /boot/efis/* <span class="c1"># if backups exist</span>
</pre></div>
</div>
</li>
<li><p>Destroy boot pool:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zpool destroy bpool_<span class="nv">$INST_UUID</span>
</pre></div>
</div>
</li>
<li><p>Enter LUKS password:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">LUKS_PWD</span><span class="o">=</span>rootpool
</pre></div>
</div>
</li>
<li><p>Create LUKS containers:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> i in <span class="o">{</span>disk1,disk2<span class="o">}</span><span class="p">;</span> <span class="k">do</span>
 cryptsetup luksFormat -q --type luks1 /dev/disk/by-id/<span class="nv">$i</span>-part2 --key-file /etc/cryptkey.d/lukskey-bpool_<span class="nv">$INST_UUID</span>
 <span class="nb">echo</span> <span class="nv">$LUKS_PWD</span> <span class="p">|</span> cryptsetup luksAddKey /dev/disk/by-id/<span class="nv">$i</span>-part2 --key-file /etc/cryptkey.d/lukskey-bpool_<span class="nv">$INST_UUID</span>
 cryptsetup open /dev/disk/by-id/<span class="nv">$i</span>-part2 luks-bpool_<span class="nv">$INST_UUID</span>-<span class="nv">$i</span>-part2 --key-file /etc/cryptkey.d/lukskey-bpool_<span class="nv">$INST_UUID</span>
 <span class="nb">echo</span> luks-bpool_<span class="nv">$INST_UUID</span>-<span class="nv">$i</span>-part2 /dev/disk/by-id/<span class="nv">$i</span>-part2 /etc/cryptkey.d/lukskey-bpool_<span class="nv">$INST_UUID</span> discard &gt;&gt; /etc/crypttab
<span class="k">done</span>
</pre></div>
</div>
</li>
<li><p>Embed key file in initramfs:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>tee -a /etc/mkinitcpio.conf <span class="s">&lt;&lt;EOF</span>
<span class="s">FILES=(/etc/cryptkey.d/lukskey-bpool_$INST_UUID /etc/cryptkey.d/zfskey-rpool_$INST_UUID)</span>
<span class="s">EOF</span>
</pre></div>
</div>
</li>
<li><p>Recreate boot pool.</p>
<p>Reuse command from <code class="docutils literal notranslate"><span class="pre">/root/bpool_$INST_UUID-cmd</span></code>.
Remove <code class="docutils literal notranslate"><span class="pre">-R</span> <span class="pre">$INST_MNT</span></code>
and replace devices with <code class="docutils literal notranslate"><span class="pre">/dev/mapper/luks-bpool_$INST_UUID-$DISK-part2</span></code>.</p>
<p>Example:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zpool create <span class="se">\</span>
-o <span class="nv">ashift</span><span class="o">=</span><span class="m">12</span> <span class="se">\</span>
-o <span class="nv">autotrim</span><span class="o">=</span>on <span class="se">\</span>
-d -o feature@async_destroy<span class="o">=</span>enabled <span class="se">\</span>
-o feature@bookmarks<span class="o">=</span>enabled <span class="se">\</span>
-o feature@embedded_data<span class="o">=</span>enabled <span class="se">\</span>
-o feature@empty_bpobj<span class="o">=</span>enabled <span class="se">\</span>
-o feature@enabled_txg<span class="o">=</span>enabled <span class="se">\</span>
-o feature@extensible_dataset<span class="o">=</span>enabled <span class="se">\</span>
-o feature@filesystem_limits<span class="o">=</span>enabled <span class="se">\</span>
-o feature@hole_birth<span class="o">=</span>enabled <span class="se">\</span>
-o feature@large_blocks<span class="o">=</span>enabled <span class="se">\</span>
-o feature@lz4_compress<span class="o">=</span>enabled <span class="se">\</span>
-o feature@spacemap_histogram<span class="o">=</span>enabled <span class="se">\</span>
-O <span class="nv">acltype</span><span class="o">=</span>posixacl <span class="se">\</span>
-O <span class="nv">canmount</span><span class="o">=</span>off <span class="se">\</span>
-O <span class="nv">compression</span><span class="o">=</span>lz4 <span class="se">\</span>
-O <span class="nv">devices</span><span class="o">=</span>off <span class="se">\</span>
-O <span class="nv">normalization</span><span class="o">=</span>formD <span class="se">\</span>
-O <span class="nv">relatime</span><span class="o">=</span>on <span class="se">\</span>
-O <span class="nv">xattr</span><span class="o">=</span>sa <span class="se">\</span>
-O <span class="nv">mountpoint</span><span class="o">=</span>/boot <span class="se">\</span>
<span class="c1"># remove -R $INST_MNT</span>
bpool_<span class="nv">$INST_UUID</span> <span class="se">\</span>
/dev/mapper/luks-bpool_<span class="nv">$INST_UUID</span>-<span class="nv">$disk1</span>-part2
</pre></div>
</div>
</li>
<li><p>Restore boot pool backup:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>cat /root/bpool_<span class="nv">$INST_UUID</span>-pre-luks <span class="p">|</span> zfs recv bpool_<span class="nv">$INST_UUID</span>/sys
</pre></div>
</div>
</li>
<li><p>Mount boot dataset and EFI partitions:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mount /boot
mount /boot/efi
mount /boot/efis/*
</pre></div>
</div>
</li>
<li><p>Change root pool password to key file:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs change-key -l <span class="se">\</span>
-o <span class="nv">keylocation</span><span class="o">=</span>file:///etc/cryptkey.d/zfskey-rpool_<span class="nv">$INST_UUID</span> <span class="se">\</span>
-o <span class="nv">keyformat</span><span class="o">=</span>raw <span class="se">\</span>
rpool_<span class="nv">$INST_UUID</span>/sys
</pre></div>
</div>
</li>
<li><p>Remove <code class="docutils literal notranslate"><span class="pre">zfsencryptssh</span></code> hook.
Encrypted boot pool is incompatible with
password by SSH:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sed -i <span class="s1">&#39;s|zfsencryptssh||g&#39;</span> /etc/mkinitcpio.conf
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">zfsencryptssh</span></code> is not removed, initramfs will
stuck at <code class="docutils literal notranslate"><span class="pre">fail</span> <span class="pre">to</span> <span class="pre">load</span> <span class="pre">key</span> <span class="pre">material</span></code> and fail to boot.</p>
</li>
<li><p>Generate initramfs:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mkinitcpio -P
</pre></div>
</div>
</li>
<li><p>Import boot pool after starting systemd:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>tee /etc/systemd/system/zfs-bpool-import-cache.service <span class="s">&lt;&lt;EOF</span>
<span class="s">[Unit]</span>
<span class="s">Description=Import boot pool by cache file</span>
<span class="s">Documentation=man:zpool(8)</span>
<span class="s">DefaultDependencies=no</span>
<span class="s">Requires=systemd-udev-settle.service</span>
<span class="s">After=zfs-import-cache.service</span>
<span class="s">After=zfs-import.target</span>
<span class="s">Before=boot.mount</span>
<span class="s">ConditionFileNotEmpty=/etc/zfs/zpool.cache</span>
<span class="s">ConditionPathIsDirectory=/sys/module/zfs</span>

<span class="s">[Service]</span>
<span class="s">Type=oneshot</span>
<span class="s">RemainAfterExit=yes</span>
<span class="s">ExecStart=/usr/bin/zpool import -c /etc/zfs/zpool.cache -aN</span>

<span class="s">[Install]</span>
<span class="s">WantedBy=zfs-import.target</span>
<span class="s">EOF</span>

systemctl <span class="nb">enable</span> zfs-bpool-import-cache.service
</pre></div>
</div>
<p>Initramfs will still try to import boot pool
before mapping LUKS containers. This will fail
and delay boot for a few seconds.</p>
</li>
<li><p>Enable GRUB cryptodisk:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s2">&quot;GRUB_ENABLE_CRYPTODISK=y&quot;</span> &gt;&gt; /etc/default/grub
</pre></div>
</div>
</li>
<li><p>Install GRUB. See <a class="reference external" href="#grub-installation">GRUB Installation</a>.</p></li>
<li><p>Generate GRUB menu:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>grub-mkconfig -o /boot/grub/grub.cfg
</pre></div>
</div>
</li>
<li><p><strong>Important</strong>: Back up root dataset key <code class="docutils literal notranslate"><span class="pre">/etc/cryptkey.d/zfskey-rpool_$INST_UUID</span></code>
to a secure location.</p>
<p>In the possible event of LUKS container corruption,
data on root set will only be available
with this key.</p>
</li>
</ol>
<div class="section" id="secure-boot">
<h3><a class="toc-backref" href="#id31">Secure Boot</a><a class="headerlink" href="#secure-boot" title="Permalink to this headline">¶</a></h3>
<p>Recommended: With Secure Boot + encrypted boot pool + encrypted root dataset,
a chain-of-trust can be established.</p>
<ol class="arabic">
<li><p>Sign boot loader</p>
<ul>
<li><p>Use boot loader signed by Microsoft</p>
<p>Using a boot loader signed with Microsoft’s key is the
simplest and most direct approach to booting with Secure Boot active;
however, it’s also the most limiting approach.</p>
<p>Use <a class="reference external" href="https://aur.archlinux.org/packages/shim-signed/">shim-signed</a><sup>AUR</sup>
and sign <code class="docutils literal notranslate"><span class="pre">grubx64.efi</span></code> with machine owner key.
See <a class="reference external" href="https://www.rodsbooks.com/efi-bootloaders/secureboot.html#shim">here</a>.</p>
</li>
<li><p>Customized Secure Boot</p>
<p>It’s possible to replace Microsoft’s keys with your own,
which enables you to gain the benefits of Secure Boot
without using either Shim. This can be a
useful approach if you want the benefits of Secure Boot
but don’t want to trust Microsoft or any of the others
who distribute binaries signed with Microsoft’s keys.</p>
<p>See <a class="reference external" href="https://www.rodsbooks.com/efi-bootloaders/controlling-sb.html">here</a>.</p>
</li>
</ul>
</li>
<li><p>Set up a service to monitor and sign <code class="docutils literal notranslate"><span class="pre">grubx64.efi</span></code>,
as in <a class="reference external" href="#mirror-efi-system-partition">mirrored ESP</a>.</p></li>
</ol>
</div>
<div class="section" id="hibernation">
<h3><a class="toc-backref" href="#id32">Hibernation</a><a class="headerlink" href="#hibernation" title="Permalink to this headline">¶</a></h3>
<p>If a separate swap partition and
<a class="reference external" href="#encrypt-boot-pool-with-LUKS">encrypted boot pool</a>
have been configured, hibernation,
also known as suspend-to-disk, can be enabled.</p>
<ol class="arabic">
<li><p>Unload swap:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>swapoff /dev/mapper/crypt-swap
cryptsetup close crypt-swap
</pre></div>
</div>
</li>
<li><p>Check partition name and remove crypttab entry:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>grep crypt-swap /etc/crypttab <span class="p">|</span> awk <span class="s1">&#39;{ print $2 }&#39;</span>
<span class="c1"># ${DISK}-part4</span>
<span class="nv">DISK</span><span class="o">=</span>/dev/disk/by-id/nvme-foo <span class="c1"># NO -part4</span>
sed -i <span class="s1">&#39;s|crypt-swap.*||&#39;</span> /etc/crypttab
</pre></div>
</div>
<p>Swap will be handled by <code class="docutils literal notranslate"><span class="pre">encrypt</span></code> initramfs hook.</p>
</li>
<li><p>Create LUKS container:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>dd <span class="nv">bs</span><span class="o">=</span><span class="m">32</span> <span class="nv">count</span><span class="o">=</span><span class="m">1</span> <span class="k">if</span><span class="o">=</span>/dev/urandom <span class="nv">of</span><span class="o">=</span>/etc/cryptkey.d/lukskey-crypt-swap
cryptsetup luksFormat -q --type luks2 <span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>-part4 --key-file /etc/cryptkey.d/lukskey-crypt-swap
cryptsetup luksOpen <span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>-part4 crypt-swap --key-file /etc/cryptkey.d/lukskey-crypt-swap --allow-discards
mkswap /dev/mapper/crypt-swap
swapon /dev/mapper/crypt-swap
</pre></div>
</div>
</li>
<li><p>Configure mkinitcpio:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sed -i <span class="s1">&#39;s|FILES=(|FILES=(/etc/cryptkey.d/lukskey-crypt-swap |&#39;</span> /etc/mkinitcpio.conf
sed -i <span class="s1">&#39;s| zfs | encrypt resume zfs |&#39;</span> /etc/mkinitcpio.conf
</pre></div>
</div>
</li>
<li><p>Add kernel command line:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s2">&quot;GRUB_CMDLINE_LINUX=\&quot;cryptdevice=PARTUUID=</span><span class="k">$(</span>blkid -s PARTUUID -o value <span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>-part4<span class="k">)</span><span class="s2">:crypt-swap:allow-discards \</span>
<span class="s2">cryptkey=rootfs:/etc/cryptkey.d/lukskey-crypt-swap \</span>
<span class="s2">resume=/dev/mapper/crypt-swap\&quot;&quot;</span> &gt;&gt; /etc/default/grub
</pre></div>
</div>
</li>
<li><p>Regenerate initramfs and GRUB menu:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mkinitcpio -P
grub-mkconfig -o /boot/grub/grub.cfg
</pre></div>
</div>
</li>
<li><p>Test hibernation:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>systemctl hibernate
</pre></div>
</div>
<p>Close all program before testing, just in case.</p>
<p>If hibernation works, your computer will shut down.
Power it on. Computer should return to the previous state
seamlessly.</p>
</li>
</ol>
</div>
<div class="section" id="enter-luks-password-in-grub-rescue">
<h3><a class="toc-backref" href="#id33">Enter LUKS password in GRUB rescue</a><a class="headerlink" href="#enter-luks-password-in-grub-rescue" title="Permalink to this headline">¶</a></h3>
<p>Using LUKS encryption for boot pool,
if the password entered is wrong, GRUB
will drop to <code class="docutils literal notranslate"><span class="pre">grub-rescue</span></code>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>Attempting to decrypt master key...
Enter passphrase <span class="k">for</span> hd0,gpt2 <span class="o">(</span>c0987ea1a51049e9b3056622804de62a<span class="o">)</span>:
error: access denied.
error: no such cryptodisk found.
Entering rescue mode...
grub rescue&gt;
</pre></div>
</div>
<p>Try entering the password again with:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>grub rescue&gt; cryptomount hd0,gpt2
Attempting to decrypt master key...
Enter passphrase <span class="k">for</span> hd0,gpt2 <span class="o">(</span>c0987ea1a51049e9b3056622804de62a<span class="o">)</span>:
Slot <span class="m">1</span> opened
grub rescue&gt; insmod normal
grub rescue&gt; normal
</pre></div>
</div>
<p>GRUB should then boot normally.</p>
</div>
<div class="section" id="change-grub-prefix-when-disk-fails">
<h3><a class="toc-backref" href="#id34">Change GRUB prefix when disk fails</a><a class="headerlink" href="#change-grub-prefix-when-disk-fails" title="Permalink to this headline">¶</a></h3>
<p>Using encryption, when
disk failed, GRUB might fail to boot.</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Welcome to GRUB!

error: no such cryptodisk found.
Attempting to decrypt master key...
Enter passphrase for hd0,gpt2 (c0987ea1a51049e9b3056622804de62a):
Slot 1 opened
error: disk `cryptouuid/47ed1b7eb0014bc9a70aede3d8714faf&#39; not found.
Entering rescue mode...
grub rescue&gt;
</pre></div>
</div>
<p>Ensure <code class="docutils literal notranslate"><span class="pre">Slot</span> <span class="pre">1</span> <span class="pre">opened</span></code> message
is shown. If <code class="docutils literal notranslate"><span class="pre">error:</span> <span class="pre">access</span> <span class="pre">denied.</span></code> is shown,
the password entered is wrong.</p>
<ol class="arabic">
<li><p>Check prefix:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>grub rescue &gt; <span class="nb">set</span>
<span class="c1"># prefix=(cryptouuid/47ed1b7eb0014bc9a70aede3d8714faf)/sys/BOOT/default@/grub</span>
<span class="c1"># root=cryptouuid/47ed1b7eb0014bc9a70aede3d8714faf</span>
</pre></div>
</div>
</li>
<li><p>Replace <code class="docutils literal notranslate"><span class="pre">cryptouuid/UUID</span></code> with <code class="docutils literal notranslate"><span class="pre">crypto0</span></code>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>grub rescue&gt; <span class="nv">prefix</span><span class="o">=(</span>crypto0<span class="o">)</span>/sys/BOOT/default@/grub
grub rescue&gt; <span class="nv">root</span><span class="o">=</span>crypto0
</pre></div>
</div>
</li>
<li><p>Boot GRUB:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>grub rescue&gt; insmod normal
grub rescue&gt; normal
</pre></div>
</div>
</li>
</ol>
<p>GRUB should then boot normally. After entering system,
promote one backup to <code class="docutils literal notranslate"><span class="pre">/boot/efi</span></code> and reinstall GRUB with
<code class="docutils literal notranslate"><span class="pre">grub-install</span></code>.</p>
</div>
</div>
<div class="section" id="recovery">
<h2><a class="toc-backref" href="#id35">Recovery</a><a class="headerlink" href="#recovery" title="Permalink to this headline">¶</a></h2>
<div class="section" id="load-grub-cfg-in-grub-command-line">
<h3><a class="toc-backref" href="#id36">Load grub.cfg in GRUB command line</a><a class="headerlink" href="#load-grub-cfg-in-grub-command-line" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>Press <code class="docutils literal notranslate"><span class="pre">c</span></code> at GRUB menu.</p></li>
<li><p>Check prefix:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>grub &gt; <span class="nb">set</span>
<span class="c1"># ...</span>
<span class="c1"># unencrypted bpool</span>
<span class="c1"># prefix=(hd0,gpt2)/sys/BOOT/default@/grub</span>
<span class="c1"># encrypted bpool</span>
<span class="c1"># prefix=(cryptouuid/UUID)/sys/BOOT/default@/grub</span>
</pre></div>
</div>
</li>
<li><p>List available boot environments:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># unencrypted bpool</span>
grub &gt; ls <span class="o">(</span>hd0,gpt2<span class="o">)</span>/sys/BOOT <span class="c1"># press tab after &#39;T&#39;</span>
<span class="c1"># encrypted bpool</span>
grub &gt; ls <span class="o">(</span>crypto0<span class="o">)</span>/sys/BOOT <span class="c1"># press tab after &#39;T&#39;</span>
Possible files are:

@/ default/ pac-multm2/
</pre></div>
</div>
</li>
<li><p>Set new prefix:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># unencrypted bpool</span>
grub &gt; <span class="nv">prefix</span><span class="o">=(</span>hd0,gpt2<span class="o">)</span>/sys/BOOT/pac-multm2@/grub
<span class="c1"># encrypted bpool</span>
grub &gt; <span class="nv">prefix</span><span class="o">=(</span>crypto0<span class="o">)</span>/sys/BOOT/pac-multm2@/grub
</pre></div>
</div>
</li>
<li><p>Load config from new prefix:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>grub &gt; normal
</pre></div>
</div>
<p>New entries are shown below the old ones.</p>
</li>
</ol>
</div>
<div class="section" id="rescue-in-live-environment">
<h3><a class="toc-backref" href="#id37">Rescue in Live Environment</a><a class="headerlink" href="#rescue-in-live-environment" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p><a class="reference external" href="#download-arch-linux-live-image">Download Arch Linux live image</a>.</p></li>
<li><p><a class="reference external" href="#prepare-the-live-environment">Prepare the Live Environment</a>.</p></li>
<li><p>Check the <code class="docutils literal notranslate"><span class="pre">INST_UUID</span></code> with <code class="docutils literal notranslate"><span class="pre">zpool</span> <span class="pre">import</span></code>.</p></li>
<li><p>Set variables:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">INST_MNT</span><span class="o">=</span><span class="k">$(</span>mktemp -d<span class="k">)</span>
<span class="nv">INST_UUID</span><span class="o">=</span>abc123
</pre></div>
</div>
</li>
<li><p>Import and unlock root and boot pool:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zpool import -N -R <span class="nv">$INST_MNT</span> rpool_<span class="nv">$INST_UUID</span>
zpool import -N -R <span class="nv">$INST_MNT</span> bpool_<span class="nv">$INST_UUID</span>
</pre></div>
</div>
<p>If using password:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs load-key rpool_<span class="nv">$INST_UUID</span>/sys
</pre></div>
</div>
<p>If using keyfile:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs load-key -L file:///path/to/keyfile rpool_<span class="nv">$INST_UUID</span>/sys
</pre></div>
</div>
</li>
<li><p>Find the current boot environment:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs list
<span class="nv">BE</span><span class="o">=</span>default
</pre></div>
</div>
</li>
<li><p>Mount root filesystem:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs mount rpool_<span class="nv">$INST_UUID</span>/sys/ROOT/<span class="nv">$BE</span>
</pre></div>
</div>
</li>
<li><p>chroot into the system:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>arch-chroot <span class="nv">$INST_MNT</span> /bin/bash --login
mount /boot
mount /boot/efi
zfs mount -a
</pre></div>
</div>
</li>
<li><p>Finish rescue:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">exit</span>
umount <span class="nv">$INST_MNT</span>/boot/efi
zpool <span class="nb">export</span> bpool_<span class="nv">$INST_UUID</span>
zpool <span class="nb">export</span> rpool_<span class="nv">$INST_UUID</span>
reboot
</pre></div>
</div>
</li>
</ol>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="Artix Linux Root on ZFS.html" class="btn btn-neutral float-right" title="Artix Linux Root on ZFS" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="index.html" class="btn btn-neutral float-left" title="Arch Linux" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, OpenZFS.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>