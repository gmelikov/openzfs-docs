

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Artix Linux Root on ZFS &mdash; OpenZFS  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme_overrides.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/mandoc.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Debian" href="../Debian/index.html" />
    <link rel="prev" title="Arch Linux Root on ZFS" href="Arch Linux Root on ZFS.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #29667e" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/logo_main.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Getting Started</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Arch Linux</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="index.html#support">Support</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#installation">Installation</a></li>
<li class="toctree-l3"><a class="reference internal" href="index.html#check-live-image-compatibility">Check Live Image Compatibility</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html#root-on-zfs">Root on ZFS</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="Arch Linux Root on ZFS.html">Arch Linux Root on ZFS</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Artix Linux Root on ZFS</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../Debian/index.html">Debian</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Fedora.html">Fedora</a></li>
<li class="toctree-l2"><a class="reference internal" href="../FreeBSD.html">FreeBSD</a></li>
<li class="toctree-l2"><a class="reference external" href="https://wiki.gentoo.org/wiki/ZFS">Gentoo</a></li>
<li class="toctree-l2"><a class="reference external" href="https://nixos.wiki/wiki/NixOS_on_ZFS">NixOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../openSUSE/index.html">openSUSE</a></li>
<li class="toctree-l2"><a class="reference internal" href="../RHEL and CentOS.html">RHEL and CentOS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Ubuntu/index.html">Ubuntu</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../Project and Community/index.html">Project and Community</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Developer Resources/index.html">Developer Resources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Performance and Tuning/index.html">Performance and Tuning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Basic Concepts/index.html">Basic Concepts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../man/index.html">Man Pages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../msg/index.html">ZFS Messages</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../License.html">License</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">OpenZFS</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Getting Started</a> &raquo;</li>
        
          <li><a href="index.html">Arch Linux</a> &raquo;</li>
        
      <li>Artix Linux Root on ZFS</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/openzfs/openzfs-docs/blob/master/docs/Getting Started/Arch Linux/Artix Linux Root on ZFS.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="artix-linux-root-on-zfs">
<h1>Artix Linux Root on ZFS<a class="headerlink" href="#artix-linux-root-on-zfs" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="table-of-contents">
<p class="topic-title">Table of Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#overview" id="id1">Overview</a></p>
<ul>
<li><p><a class="reference internal" href="#caution" id="id2">Caution</a></p></li>
<li><p><a class="reference internal" href="#support" id="id3">Support</a></p></li>
<li><p><a class="reference internal" href="#contributing" id="id4">Contributing</a></p></li>
<li><p><a class="reference internal" href="#encryption" id="id5">Encryption</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#preinstallation" id="id6">Preinstallation</a></p>
<ul>
<li><p><a class="reference internal" href="#download-artix-linux-live-image" id="id7">Download Artix Linux live image</a></p></li>
<li><p><a class="reference internal" href="#prepare-the-live-environment" id="id8">Prepare the Live Environment</a></p></li>
<li><p><a class="reference internal" href="#installation-variables" id="id9">Installation Variables</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#system-installation" id="id10">System Installation</a></p>
<ul>
<li><p><a class="reference internal" href="#format-and-partition-the-target-disks" id="id11">Format and Partition the Target Disks</a></p></li>
<li><p><a class="reference internal" href="#create-root-and-boot-pools" id="id12">Create Root and Boot Pools</a></p></li>
<li><p><a class="reference internal" href="#create-datasets" id="id13">Create Datasets</a></p></li>
<li><p><a class="reference internal" href="#format-and-mount-efi-system-partition" id="id14">Format and Mount EFI System Partition</a></p></li>
<li><p><a class="reference internal" href="#package-installation" id="id15">Package Installation</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#system-configuration" id="id16">System Configuration</a></p></li>
<li><p><a class="reference internal" href="#bootloader-installation" id="id17">Bootloader Installation</a></p>
<ul>
<li><p><a class="reference internal" href="#grub-probe-fails-to-get-canonical-path" id="id18">grub-probe fails to get canonical path</a></p></li>
<li><p><a class="reference internal" href="#pool-name-missing" id="id19">Pool name missing</a></p></li>
<li><p><a class="reference internal" href="#grub-installation" id="id20">GRUB Installation</a></p></li>
<li><p><a class="reference internal" href="#generate-grub-boot-menu" id="id21">Generate GRUB Boot Menu</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#optional-configuration" id="id22">Optional Configuration</a></p>
<ul>
<li><p><a class="reference internal" href="#supply-password-with-ssh" id="id23">Supply password with SSH</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#finish-installation" id="id24">Finish Installation</a></p></li>
<li><p><a class="reference internal" href="#after-reboot" id="id25">After Reboot</a></p>
<ul>
<li><p><a class="reference internal" href="#mirror-efi-system-partition" id="id26">Mirror EFI System Partition</a></p></li>
<li><p><a class="reference internal" href="#mirror-bios-boot-sector" id="id27">Mirror BIOS boot sector</a></p></li>
<li><p><a class="reference internal" href="#boot-environment-manager" id="id28">Boot Environment Manager</a></p></li>
<li><p><a class="reference internal" href="#post-installation" id="id29">Post installation</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#recovery" id="id30">Recovery</a></p>
<ul>
<li><p><a class="reference internal" href="#load-grub-cfg-in-grub-command-line" id="id31">Load grub.cfg in GRUB command line</a></p></li>
<li><p><a class="reference internal" href="#rescue-in-live-environment" id="id32">Rescue in Live Environment</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="overview">
<h2><a class="toc-backref" href="#id1">Overview</a><a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://artixlinux.org/">Artix Linux</a> is a systemd-free distribution based on Arch Linux.</p>
<p>OpenRC, runit and s6 are supported init systems.</p>
<div class="section" id="caution">
<h3><a class="toc-backref" href="#id2">Caution</a><a class="headerlink" href="#caution" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>This guide uses entire physical disks.</p></li>
<li><p>Multiple systems on one disk is not supported.</p></li>
<li><p>Target disk will be wiped. Back up your data before continuing.</p></li>
<li><p>The target system, virtual or physical, must have at least 4GB RAM,
or the DKMS module might fail to build.</p></li>
<li><p>Installing on a drive which presents 4 KiB logical sectors (a “4Kn” drive)
only works with UEFI booting. This not unique to ZFS. <a class="reference external" href="http://savannah.gnu.org/bugs/?46700">GRUB does not and
will not work on 4Kn with legacy (BIOS) booting.</a></p></li>
</ul>
</div>
<div class="section" id="support">
<h3><a class="toc-backref" href="#id3">Support</a><a class="headerlink" href="#support" title="Permalink to this headline">¶</a></h3>
<p>If you need help, reach out to the community using the <a class="reference internal" href="../../Project and Community/Mailing Lists.html#mailing-lists"><span class="std std-ref">Mailing Lists</span></a> or IRC at
<a class="reference external" href="irc://irc.freenode.net/#zfsonlinux">#zfsonlinux</a> on <a class="reference external" href="https://freenode.net/">freenode</a>. If you have a bug report or feature request
related to this HOWTO, please <a class="reference external" href="https://github.com/openzfs/openzfs-docs/issues/new?body=&#64;ne9z,%20I%20have%20the%20following%20issue%20with%20the%20Artix%20Linux%20Root%20on%20ZFS%20HOWTO:">file a new issue and mention &#64;ne9z</a>.</p>
</div>
<div class="section" id="contributing">
<h3><a class="toc-backref" href="#id4">Contributing</a><a class="headerlink" href="#contributing" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>Fork and clone <a class="reference external" href="https://github.com/openzfs/openzfs-docs">this repo</a>.</p></li>
<li><p>Install the tools:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo pacman -S python-pip

pip3 install -r docs/requirements.txt

<span class="c1"># Add ~/.local/bin to your $PATH, e.g. by adding this to ~/.bashrc:</span>
<span class="nv">PATH</span><span class="o">=</span><span class="nv">$HOME</span>/.local/bin:<span class="nv">$PATH</span>
</pre></div>
</div>
</li>
<li><p>Make your changes.</p></li>
<li><p>Test:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> docs
make html
sensible-browser _build/html/index.html
</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">commit</span> <span class="pre">--signoff</span></code> to a branch, <code class="docutils literal notranslate"><span class="pre">git</span> <span class="pre">push</span></code>, and create a pull
request. Mention &#64;rlaager.</p></li>
</ol>
</div>
<div class="section" id="encryption">
<h3><a class="toc-backref" href="#id5">Encryption</a><a class="headerlink" href="#encryption" title="Permalink to this headline">¶</a></h3>
<p>This guide supports optional ZFS native encryption on root pool.</p>
<p>Unencrypted does not encrypt anything, of course. With no encryption
happening, this option naturally has the best performance.</p>
<p>ZFS native encryption encrypts the data and most metadata in the root
pool. It does not encrypt dataset or snapshot names or properties. The
boot pool is not encrypted at all, but it only contains the bootloader,
kernel, and initrd. (Unless you put a password in <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code>, the
initrd is unlikely to contain sensitive data.) The system cannot boot
without the passphrase being entered at the console. Performance is
good. As the encryption happens in ZFS, even if multiple disks (mirror
or raidz topologies) are used, the data only has to be encrypted once.</p>
</div>
</div>
<div class="section" id="preinstallation">
<h2><a class="toc-backref" href="#id6">Preinstallation</a><a class="headerlink" href="#preinstallation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="download-artix-linux-live-image">
<h3><a class="toc-backref" href="#id7">Download Artix Linux live image</a><a class="headerlink" href="#download-artix-linux-live-image" title="Permalink to this headline">¶</a></h3>
<p>OpenRC is used throughout this guide.</p>
<p>Other init systems, runit and s6, are also supported.
Change the service commands to the equivalent commands.</p>
<ol class="arabic">
<li><p>Choose a mirror:</p>
<blockquote>
<div><p><a class="reference external" href="https://artixlinux.org/download.php">Mirrorlist</a></p>
</div></blockquote>
</li>
<li><p>Download January 2021 build and signature. <a class="reference external" href="https://github.com/openzfs/openzfs-docs/issues/new?body=&#64;ne9z,%20Update%20Live%20Image%20Artix%20Linux%20Root%20on%20ZFS%20HOWTO:">File a new issue and mention &#64;ne9z</a> if it’s
no longer available.</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference external" href="https://iso.artixlinux.org/iso/artix-base-openrc-20210101-x86_64.iso">ISO (US mirror)</a></p></li>
<li><p><a class="reference external" href="https://iso.artixlinux.org/iso/artix-base-openrc-20210101-x86_64.iso.sig">Signature</a></p></li>
</ul>
</div></blockquote>
</li>
<li><p>Check live image against signature:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>gpg --auto-key-retrieve --verify artix-base-openrc-20210101-x86_64.iso.sig
</pre></div>
</div>
<p>If the file is authentic, output should be the following:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>gpg: Signature made Sun <span class="m">03</span> Jan <span class="m">2021</span> <span class="m">09</span>:30:42 PM UTC
gpg:                using RSA key A574A1915CEDE31A3BFF5A68606520ACB886B428
gpg: Good signature from <span class="s2">&quot;Christos Nouskas &lt;nous@artixlinux.org&gt;&quot;</span> <span class="o">[</span>unknown<span class="o">]</span>
...
Primary key fingerprint: A574 A191 5CED E31A 3BFF  5A68 <span class="m">6065</span> 20AC B886 B428
</pre></div>
</div>
<p>Ensure <code class="docutils literal notranslate"><span class="pre">Good</span> <span class="pre">signature</span></code> and last 8 digits are <code class="docutils literal notranslate"><span class="pre">B886</span> <span class="pre">B428</span></code>,
as listed on <a class="reference external" href="https://artixlinux.org/download.php">Artix Linux Download</a> page.</p>
</li>
<li><p>Write the image to a USB drive or an optical disc.</p></li>
<li><p>Boot the target computer from the prepared live medium.</p></li>
<li><p>At GRUB menu, select “From ISO: artix x86_64”.</p></li>
</ol>
</div>
<div class="section" id="prepare-the-live-environment">
<h3><a class="toc-backref" href="#id8">Prepare the Live Environment</a><a class="headerlink" href="#prepare-the-live-environment" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>Connect to the internet.
If the target computer aquires IP address with DHCP,
no further steps need to be taken.
Otherwise, refer to
<a class="reference external" href="https://wiki.archlinux.org/index.php/Network_configuration">Network Configuration</a>
wiki page.</p></li>
<li><p>Become root:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sudo -i
</pre></div>
</div>
</li>
<li><p>Start SSH server.</p>
<ul>
<li><p>Interactively set root password with:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>passwd
</pre></div>
</div>
</li>
<li><p>Permit root login with password:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> PermitRootLogin yes &gt;&gt; /etc/ssh/sshd_config
</pre></div>
</div>
</li>
<li><p>Start SSH server:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>rc-service sshd start
</pre></div>
</div>
</li>
<li><p>Find the IP address of the target computer:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ip -4 address show scope global
</pre></div>
</div>
</li>
<li><p>On another computer, connect to the target computer with:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ssh root@192.168.1.10
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>Enter a bash shell:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>bash
</pre></div>
</div>
</li>
<li><p>Import keys of archzfs repository:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>curl -L https://archzfs.com/archzfs.gpg <span class="p">|</span>  pacman-key -a -
curl -L https://git.io/JtQpl <span class="p">|</span> xargs -i<span class="o">{}</span> pacman-key --lsign-key <span class="o">{}</span>
</pre></div>
</div>
</li>
<li><p>Add archzfs repository:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>tee -a /etc/pacman.conf <span class="s">&lt;&lt;- &#39;EOF&#39;</span>

<span class="s">[archzfs]</span>
<span class="s">Include = /etc/pacman.d/mirrorlist-archzfs</span>
<span class="s">EOF</span>

curl -L https://git.io/JtQp4 &gt; /etc/pacman.d/mirrorlist-archzfs
</pre></div>
</div>
</li>
<li><p>Select mirror:</p>
<ul>
<li><p>Edit the following files:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>nano /etc/pacman.d/mirrorlist
nano /etc/pacman.d/mirrorlist-arch
</pre></div>
</div>
<p>Uncomment and move mirrors to
the beginning of the file.</p>
</li>
<li><p>Update database:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>pacman -Sy
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>Install ZFS and tools in the live environment:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>pacman -Sy --noconfirm gdisk dosfstools zfs-dkms glibc
</pre></div>
</div>
</li>
<li><p>Load kernel module:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>modprobe zfs
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="installation-variables">
<h3><a class="toc-backref" href="#id9">Installation Variables</a><a class="headerlink" href="#installation-variables" title="Permalink to this headline">¶</a></h3>
<p>In this part, we will set some variables to configure the system.</p>
<ol class="arabic">
<li><p>Timezone</p>
<p>List the available timezones with:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ls /usr/share/zoneinfo/
</pre></div>
</div>
<p>Store the target timezone in a variable:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">INST_TZ</span><span class="o">=</span>/usr/share/zoneinfo/Asia/Irkutsk
</pre></div>
</div>
</li>
<li><p>Host name</p>
<p>Store the host name in a variable:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">INST_HOST</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span>
</pre></div>
</div>
</li>
<li><p>Kernel variant</p>
<p>Store the kernel variant in a variable.
Available variants in official repo are:</p>
<ul class="simple">
<li><p>linux</p></li>
<li><p>linux-lts</p></li>
<li><p>linux-zen</p></li>
</ul>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">INST_LINVAR</span><span class="o">=</span><span class="s1">&#39;linux&#39;</span>
</pre></div>
</div>
</li>
<li><p>Target disk</p>
<p>List the available disks with:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ls -d /dev/disk/by-id/* <span class="p">|</span> grep -v part
</pre></div>
</div>
<p>If the disk is connected with VirtIO, use <code class="docutils literal notranslate"><span class="pre">/dev/vd*</span></code>.
And replace <code class="docutils literal notranslate"><span class="pre">${DISK}-part</span></code> in this guide with <code class="docutils literal notranslate"><span class="pre">${DISK}</span></code></p>
<p>Store the target disk in a variable:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">DISK</span><span class="o">=</span>/dev/disk/by-id/nvme-foo_NVMe_bar_512GB
</pre></div>
</div>
<p>For multi-disk setups, repeat the formatting and
partitioning commands for other disks.</p>
</li>
<li><p>Create a mountpoint with:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">INST_MNT</span><span class="o">=</span><span class="k">$(</span>mktemp -d<span class="k">)</span>
</pre></div>
</div>
</li>
<li><p>To avoid name conflict when importing pools on another computer,
Give them a unique suffix:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">INST_UUID</span><span class="o">=</span><span class="k">$(</span>dd <span class="k">if</span><span class="o">=</span>/dev/urandom <span class="nv">of</span><span class="o">=</span>/dev/stdout <span class="nv">bs</span><span class="o">=</span><span class="m">1</span> <span class="nv">count</span><span class="o">=</span><span class="m">100</span> <span class="m">2</span>&gt;/dev/null <span class="p">|</span>tr -dc <span class="s1">&#39;a-z0-9&#39;</span> <span class="p">|</span> cut -c-6<span class="k">)</span>
</pre></div>
</div>
</li>
</ol>
</div>
</div>
<div class="section" id="system-installation">
<h2><a class="toc-backref" href="#id10">System Installation</a><a class="headerlink" href="#system-installation" title="Permalink to this headline">¶</a></h2>
<div class="section" id="format-and-partition-the-target-disks">
<h3><a class="toc-backref" href="#id11">Format and Partition the Target Disks</a><a class="headerlink" href="#format-and-partition-the-target-disks" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>Clear the partition table:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sgdisk --zap-all <span class="nv">$DISK</span>
</pre></div>
</div>
</li>
<li><p>Create EFI system partition (for use now or in the future):</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sgdisk -n1:1M:+1G -t1:EF00 <span class="nv">$DISK</span>
</pre></div>
</div>
</li>
<li><p>Create BIOS boot partition:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sgdisk -a1 -n5:24K:+1000K -t5:EF02 <span class="nv">$DISK</span>
</pre></div>
</div>
</li>
<li><p>Create boot pool partition:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sgdisk -n2:0:+4G -t2:BE00 <span class="nv">$DISK</span>
</pre></div>
</div>
</li>
<li><p>Create root pool partition:</p>
<ul>
<li><p>If you don’t need a separate swap partition:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sgdisk -n3:0:0 -t3:BF00 <span class="nv">$DISK</span>
</pre></div>
</div>
</li>
<li><p>If a separate swap partition is needed:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sgdisk -n3:0:-8G -t3:BF00 <span class="nv">$DISK</span>
sgdisk -n4:0:0   -t4:8308 <span class="nv">$DISK</span>
</pre></div>
</div>
</li>
</ul>
<blockquote>
<div><p>Adjust the swap partition size to your needs.</p>
</div></blockquote>
</li>
<li><p>Repeat the above steps for other target disks, if any.</p></li>
</ol>
</div>
<div class="section" id="create-root-and-boot-pools">
<h3><a class="toc-backref" href="#id12">Create Root and Boot Pools</a><a class="headerlink" href="#create-root-and-boot-pools" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>For multi-disk setup</p>
<p>If you want to create a multi-disk pool, replace <code class="docutils literal notranslate"><span class="pre">${DISK}-partX</span></code>
with the topology and the disk path.</p>
<p>For example, change:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zpool create <span class="se">\</span>
  ... <span class="se">\</span>
  <span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>-part2
</pre></div>
</div>
<p>to:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zpool create <span class="se">\</span>
  ... <span class="se">\</span>
  mirror <span class="se">\</span>
  /dev/disk/by-id/ata-disk1-part2 <span class="se">\</span>
  /dev/disk/by-id/ata-disk2-part2
</pre></div>
</div>
<p>if needed, replace <code class="docutils literal notranslate"><span class="pre">mirror</span></code> with <code class="docutils literal notranslate"><span class="pre">raidz1</span></code>, <code class="docutils literal notranslate"><span class="pre">raidz2</span></code> or <code class="docutils literal notranslate"><span class="pre">raidz3</span></code>.</p>
</li>
<li><p>Create boot pool:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zpool create <span class="se">\</span>
    -o <span class="nv">ashift</span><span class="o">=</span><span class="m">12</span> <span class="se">\</span>
    -o <span class="nv">autotrim</span><span class="o">=</span>on <span class="se">\</span>
    -d -o feature@async_destroy<span class="o">=</span>enabled <span class="se">\</span>
    -o feature@bookmarks<span class="o">=</span>enabled <span class="se">\</span>
    -o feature@embedded_data<span class="o">=</span>enabled <span class="se">\</span>
    -o feature@empty_bpobj<span class="o">=</span>enabled <span class="se">\</span>
    -o feature@enabled_txg<span class="o">=</span>enabled <span class="se">\</span>
    -o feature@extensible_dataset<span class="o">=</span>enabled <span class="se">\</span>
    -o feature@filesystem_limits<span class="o">=</span>enabled <span class="se">\</span>
    -o feature@hole_birth<span class="o">=</span>enabled <span class="se">\</span>
    -o feature@large_blocks<span class="o">=</span>enabled <span class="se">\</span>
    -o feature@lz4_compress<span class="o">=</span>enabled <span class="se">\</span>
    -o feature@spacemap_histogram<span class="o">=</span>enabled <span class="se">\</span>
    -O <span class="nv">acltype</span><span class="o">=</span>posixacl <span class="se">\</span>
    -O <span class="nv">canmount</span><span class="o">=</span>off <span class="se">\</span>
    -O <span class="nv">compression</span><span class="o">=</span>lz4 <span class="se">\</span>
    -O <span class="nv">devices</span><span class="o">=</span>off <span class="se">\</span>
    -O <span class="nv">normalization</span><span class="o">=</span>formD <span class="se">\</span>
    -O <span class="nv">relatime</span><span class="o">=</span>on <span class="se">\</span>
    -O <span class="nv">xattr</span><span class="o">=</span>sa <span class="se">\</span>
    -O <span class="nv">mountpoint</span><span class="o">=</span>/boot <span class="se">\</span>
    -R <span class="nv">$INST_MNT</span> <span class="se">\</span>
    bpool_<span class="nv">$INST_UUID</span> <span class="se">\</span>
    <span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>-part2
</pre></div>
</div>
<p>You should not need to customize any of the options for the boot pool.</p>
<p>GRUB does not support all of the zpool features. See <code class="docutils literal notranslate"><span class="pre">spa_feature_names</span></code>
in <a class="reference external" href="http://git.savannah.gnu.org/cgit/grub.git/tree/grub-core/fs/zfs/zfs.c#n276">grub-core/fs/zfs/zfs.c</a>.
This step creates a separate boot pool for <code class="docutils literal notranslate"><span class="pre">/boot</span></code> with the features
limited to only those that GRUB supports, allowing the root pool to use
any/all features. Note that GRUB opens the pool read-only, so all
read-only compatible features are “supported” by GRUB.</p>
<p><strong>Feature Notes:</strong></p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">allocation_classes</span></code> feature should be safe to use. However, unless
one is using it (i.e. a <code class="docutils literal notranslate"><span class="pre">special</span></code> vdev), there is no point to enabling
it. It is extremely unlikely that someone would use this feature for a
boot pool. If one cares about speeding up the boot pool, it would make
more sense to put the whole pool on the faster disk rather than using it
as a <code class="docutils literal notranslate"><span class="pre">special</span></code> vdev.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">project_quota</span></code> feature has been tested and is safe to use. This
feature is extremely unlikely to matter for the boot pool.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">resilver_defer</span></code> should be safe but the boot pool is small enough
that it is unlikely to be necessary.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">spacemap_v2</span></code> feature has been tested and is safe to use. The boot
pool is small, so this does not matter in practice.</p></li>
<li><p>As a read-only compatible feature, the <code class="docutils literal notranslate"><span class="pre">userobj_accounting</span></code> feature
should be compatible in theory, but in practice, GRUB can fail with an
“invalid dnode type” error. This feature does not matter for <code class="docutils literal notranslate"><span class="pre">/boot</span></code>
anyway.</p></li>
</ul>
</li>
<li><p>Create root pool:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zpool create <span class="se">\</span>
 -o <span class="nv">ashift</span><span class="o">=</span><span class="m">12</span> <span class="se">\</span>
 -o <span class="nv">autotrim</span><span class="o">=</span>on <span class="se">\</span>
 -R <span class="nv">$INST_MNT</span> <span class="se">\</span>
 -O <span class="nv">acltype</span><span class="o">=</span>posixacl <span class="se">\</span>
 -O <span class="nv">canmount</span><span class="o">=</span>off <span class="se">\</span>
 -O <span class="nv">compression</span><span class="o">=</span>zstd <span class="se">\</span>
 -O <span class="nv">dnodesize</span><span class="o">=</span>auto <span class="se">\</span>
 -O <span class="nv">normalization</span><span class="o">=</span>formD <span class="se">\</span>
 -O <span class="nv">relatime</span><span class="o">=</span>on <span class="se">\</span>
 -O <span class="nv">xattr</span><span class="o">=</span>sa <span class="se">\</span>
 -O <span class="nv">mountpoint</span><span class="o">=</span>/ <span class="se">\</span>
 rpool_<span class="nv">$INST_UUID</span> <span class="se">\</span>
 <span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>-part3
</pre></div>
</div>
<p><strong>Notes:</strong></p>
<ul class="simple">
<li><p>The use of <code class="docutils literal notranslate"><span class="pre">ashift=12</span></code> is recommended here because many drives
today have 4 KiB (or larger) physical sectors, even though they
present 512 B logical sectors. Also, a future replacement drive may
have 4 KiB physical sectors (in which case <code class="docutils literal notranslate"><span class="pre">ashift=12</span></code> is desirable)
or 4 KiB logical sectors (in which case <code class="docutils literal notranslate"><span class="pre">ashift=12</span></code> is required).</p></li>
<li><p>Setting <code class="docutils literal notranslate"><span class="pre">-O</span> <span class="pre">acltype=posixacl</span></code> enables POSIX ACLs globally. If you
do not want this, remove that option, but later add
<code class="docutils literal notranslate"><span class="pre">-o</span> <span class="pre">acltype=posixacl</span></code> (note: lowercase “o”) to the <code class="docutils literal notranslate"><span class="pre">zfs</span> <span class="pre">create</span></code>
for <code class="docutils literal notranslate"><span class="pre">/var/log</span></code>, as <a class="reference external" href="https://askubuntu.com/questions/970886/journalctl-says-failed-to-search-journal-acl-operation-not-supported">journald requires ACLs</a></p></li>
<li><p>Setting <code class="docutils literal notranslate"><span class="pre">normalization=formD</span></code> eliminates some corner cases relating
to UTF-8 filename normalization. It also implies <code class="docutils literal notranslate"><span class="pre">utf8only=on</span></code>,
which means that only UTF-8 filenames are allowed. If you care to
support non-UTF-8 filenames, do not use this option. For a discussion
of why requiring UTF-8 filenames may be a bad idea, see <a class="reference external" href="http://utcc.utoronto.ca/~cks/space/blog/linux/ForcedUTF8Filenames">The problems
with enforced UTF-8 only filenames</a>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">recordsize</span></code> is unset (leaving it at the default of 128 KiB). If you
want to tune it (e.g. <code class="docutils literal notranslate"><span class="pre">-o</span> <span class="pre">recordsize=1M</span></code>), see <a class="reference external" href="https://jrs-s.net/2019/04/03/on-zfs-recordsize/">these</a> <a class="reference external" href="http://blog.programster.org/zfs-record-size">various</a> <a class="reference external" href="https://utcc.utoronto.ca/~cks/space/blog/solaris/ZFSFileRecordsizeGrowth">blog</a>
<a class="reference external" href="https://utcc.utoronto.ca/~cks/space/blog/solaris/ZFSRecordsizeAndCompression">posts</a>.</p></li>
<li><p>Setting <code class="docutils literal notranslate"><span class="pre">relatime=on</span></code> is a middle ground between classic POSIX
<code class="docutils literal notranslate"><span class="pre">atime</span></code> behavior (with its significant performance impact) and
<code class="docutils literal notranslate"><span class="pre">atime=off</span></code> (which provides the best performance by completely
disabling atime updates). Since Linux 2.6.30, <code class="docutils literal notranslate"><span class="pre">relatime</span></code> has been
the default for other filesystems. See <a class="reference external" href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/6/html/power_management_guide/relatime">RedHat’s documentation</a>
for further information.</p></li>
<li><p>Setting <code class="docutils literal notranslate"><span class="pre">xattr=sa</span></code> <a class="reference external" href="https://github.com/zfsonlinux/zfs/commit/82a37189aac955c81a59a5ecc3400475adb56355">vastly improves the performance of extended
attributes</a>.
Inside ZFS, extended attributes are used to implement POSIX ACLs.
Extended attributes can also be used by user-space applications.
<a class="reference external" href="https://en.wikipedia.org/wiki/Extended_file_attributes#Linux">They are used by some desktop GUI applications.</a>
<a class="reference external" href="https://wiki.samba.org/index.php/Setting_up_a_Share_Using_Windows_ACLs">They can be used by Samba to store Windows ACLs and DOS attributes;
they are required for a Samba Active Directory domain controller.</a>
Note that <code class="docutils literal notranslate"><span class="pre">xattr=sa</span></code> is <a class="reference external" href="https://openzfs.org/wiki/Platform_code_differences">Linux-specific</a>. If you move your
<code class="docutils literal notranslate"><span class="pre">xattr=sa</span></code> pool to another OpenZFS implementation besides ZFS-on-Linux,
extended attributes will not be readable (though your data will be). If
portability of extended attributes is important to you, omit the
<code class="docutils literal notranslate"><span class="pre">-O</span> <span class="pre">xattr=sa</span></code> above. Even if you do not want <code class="docutils literal notranslate"><span class="pre">xattr=sa</span></code> for the whole
pool, it is probably fine to use it for <code class="docutils literal notranslate"><span class="pre">/var/log</span></code>.</p></li>
<li><p>Make sure to include the <code class="docutils literal notranslate"><span class="pre">-part3</span></code> portion of the drive path. If you
forget that, you are specifying the whole disk, which ZFS will then
re-partition, and you will lose the bootloader partition(s).</p></li>
<li><p>ZFS native encryption <a class="reference external" href="https://github.com/openzfs/zfs/commit/31b160f0a6c673c8f926233af2ed6d5354808393">now</a>
defaults to <code class="docutils literal notranslate"><span class="pre">aes-256-gcm</span></code>.</p></li>
<li><p>Your passphrase will likely be the weakest link. Choose wisely. See
<a class="reference external" href="https://gitlab.com/cryptsetup/cryptsetup/wikis/FrequentlyAskedQuestions#5-security-aspects">section 5 of the cryptsetup FAQ</a>
for guidance.</p></li>
</ul>
</li>
</ol>
</div>
<div class="section" id="create-datasets">
<h3><a class="toc-backref" href="#id13">Create Datasets</a><a class="headerlink" href="#create-datasets" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>Create system boot container:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs create <span class="se">\</span>
 -o <span class="nv">canmount</span><span class="o">=</span>off <span class="se">\</span>
 -o <span class="nv">mountpoint</span><span class="o">=</span>/boot <span class="se">\</span>
 bpool_<span class="nv">$INST_UUID</span>/sys
</pre></div>
</div>
</li>
<li><p>Create system root container:</p>
<p>Dataset encryption is set at creation and can not be altered later,
but encrypted dataset can be created inside an unencrypted parent dataset.</p>
<ul>
<li><p>Unencrypted:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs create <span class="se">\</span>
 -o <span class="nv">canmount</span><span class="o">=</span>off <span class="se">\</span>
 -o <span class="nv">mountpoint</span><span class="o">=</span>/ <span class="se">\</span>
 rpool_<span class="nv">$INST_UUID</span>/sys
</pre></div>
</div>
</li>
<li><p>Encrypted:</p>
<ol class="arabic">
<li><p>Choose a strong password.</p>
<p>Once the password is compromised,
dataset and pool must be destroyed,
disk wiped and system rebuilt from scratch to protect confidentiality.
<a class="reference external" href="https://openzfs.github.io/openzfs-docs/man/8/zfs-change-key.8.html">Merely changing password is not enough</a>.</p>
<p>Example: generate passphrase with <a class="reference external" href="https://github.com/redacted/XKCD-password-generator">xkcdpass</a>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>pacman -S --noconfirm xkcdpass
xkcdpass -Vn <span class="m">10</span> -w /usr/lib/python*/site-packages/xkcdpass/static/eff-long
</pre></div>
</div>
<p>Password can be supplied with SSH at boot time,
see <a class="reference external" href="#supply-password-with-ssh">Supply password with SSH</a>.</p>
</li>
<li><p>Create dataset:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs create <span class="se">\</span>
 -o <span class="nv">canmount</span><span class="o">=</span>off <span class="se">\</span>
 -o <span class="nv">mountpoint</span><span class="o">=</span>/ <span class="se">\</span>
 -o <span class="nv">encryption</span><span class="o">=</span>on <span class="se">\</span>
 -o <span class="nv">keylocation</span><span class="o">=</span>prompt <span class="se">\</span>
 -o <span class="nv">keyformat</span><span class="o">=</span>passphrase <span class="se">\</span>
 rpool_<span class="nv">$INST_UUID</span>/sys
</pre></div>
</div>
</li>
</ol>
</li>
</ul>
</li>
<li><p>Create container datasets:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs create -o <span class="nv">canmount</span><span class="o">=</span>off -o <span class="nv">mountpoint</span><span class="o">=</span>none bpool_<span class="nv">$INST_UUID</span>/sys/BOOT
zfs create -o <span class="nv">canmount</span><span class="o">=</span>off -o <span class="nv">mountpoint</span><span class="o">=</span>none rpool_<span class="nv">$INST_UUID</span>/sys/ROOT
zfs create -o <span class="nv">canmount</span><span class="o">=</span>off -o <span class="nv">mountpoint</span><span class="o">=</span>none rpool_<span class="nv">$INST_UUID</span>/sys/DATA
</pre></div>
</div>
</li>
<li><p>Create root and boot filesystem datasets:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs create -o <span class="nv">mountpoint</span><span class="o">=</span>legacy -o <span class="nv">canmount</span><span class="o">=</span>noauto bpool_<span class="nv">$INST_UUID</span>/sys/BOOT/default
zfs create -o <span class="nv">mountpoint</span><span class="o">=</span>/      -o <span class="nv">canmount</span><span class="o">=</span>noauto rpool_<span class="nv">$INST_UUID</span>/sys/ROOT/default
</pre></div>
</div>
</li>
<li><p>Mount root and boot filesystem datasets:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs mount rpool_<span class="nv">$INST_UUID</span>/sys/ROOT/default
mkdir <span class="nv">$INST_MNT</span>/boot
mount -t zfs bpool_<span class="nv">$INST_UUID</span>/sys/BOOT/default <span class="nv">$INST_MNT</span>/boot
</pre></div>
</div>
</li>
<li><p>Create datasets to separate user data from root filesystem:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs create -o <span class="nv">mountpoint</span><span class="o">=</span>/ -o <span class="nv">canmount</span><span class="o">=</span>off rpool_<span class="nv">$INST_UUID</span>/sys/DATA/default

<span class="k">for</span> i in <span class="o">{</span>usr,var,var/lib<span class="o">}</span><span class="p">;</span>
<span class="k">do</span>
    zfs create -o <span class="nv">canmount</span><span class="o">=</span>off rpool_<span class="nv">$INST_UUID</span>/sys/DATA/default/<span class="nv">$i</span>
<span class="k">done</span>

<span class="k">for</span> i in <span class="o">{</span>home,root,srv,usr/local,var/log,var/spool,var/tmp<span class="o">}</span><span class="p">;</span>
<span class="k">do</span>
    zfs create -o <span class="nv">canmount</span><span class="o">=</span>on rpool_<span class="nv">$INST_UUID</span>/sys/DATA/default/<span class="nv">$i</span>
<span class="k">done</span>

chmod <span class="m">750</span> <span class="nv">$INST_MNT</span>/root
chmod <span class="m">1777</span> <span class="nv">$INST_MNT</span>/var/tmp
</pre></div>
</div>
</li>
<li><p>Optional user data datasets:</p>
<p>If this system will have games installed:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs create -o <span class="nv">canmount</span><span class="o">=</span>on rpool_<span class="nv">$INST_UUID</span>/sys/DATA/default/var/games
</pre></div>
</div>
<p>If you use /var/www on this system:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs create -o <span class="nv">canmount</span><span class="o">=</span>on rpool_<span class="nv">$INST_UUID</span>/sys/DATA/default/var/www
</pre></div>
</div>
<p>If this system will use GNOME:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs create -o <span class="nv">canmount</span><span class="o">=</span>on rpool_<span class="nv">$INST_UUID</span>/sys/DATA/default/var/lib/AccountsService
</pre></div>
</div>
<p>If this system will use Docker (which manages its own datasets &amp;
snapshots):</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs create -o <span class="nv">canmount</span><span class="o">=</span>on rpool_<span class="nv">$INST_UUID</span>/sys/DATA/default/var/lib/docker
</pre></div>
</div>
<p>If this system will use NFS (locking):</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs create -o <span class="nv">canmount</span><span class="o">=</span>on rpool_<span class="nv">$INST_UUID</span>/sys/DATA/default/var/lib/nfs
</pre></div>
</div>
<p>If this system will use Linux Containers:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs create -o <span class="nv">canmount</span><span class="o">=</span>on rpool_<span class="nv">$INST_UUID</span>/sys/DATA/default/var/lib/lxc
</pre></div>
</div>
<p>If this system will use libvirt:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs create -o <span class="nv">canmount</span><span class="o">=</span>on rpool_<span class="nv">$INST_UUID</span>/sys/DATA/default/var/lib/libvirt
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="format-and-mount-efi-system-partition">
<h3><a class="toc-backref" href="#id14">Format and Mount EFI System Partition</a><a class="headerlink" href="#format-and-mount-efi-system-partition" title="Permalink to this headline">¶</a></h3>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mkfs.vfat -n EFI <span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>-part1
mkdir <span class="nv">$INST_MNT</span>/boot/efi
mount -t vfat <span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>-part1 <span class="nv">$INST_MNT</span>/boot/efi
</pre></div>
</div>
<p>If you are using a multi-disk setup, this step will only install
bootloader to the first disk. Other disks will be handled later.</p>
</div>
<div class="section" id="package-installation">
<h3><a class="toc-backref" href="#id15">Package Installation</a><a class="headerlink" href="#package-installation" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>Install base packages:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>basestrap <span class="nv">$INST_MNT</span> base vi mandoc grub connman connman-openrc openrc elogind-openrc
</pre></div>
</div>
</li>
<li><p>Install kernel headers and zfs-dkms package:</p>
<p>Check kernel version:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">INST_LINVER</span><span class="o">=</span><span class="k">$(</span>pacman -Syi <span class="si">${</span><span class="nv">INST_LINVAR</span><span class="si">}</span> <span class="p">|</span> grep Version <span class="p">|</span> awk <span class="s1">&#39;{ print $3 }&#39;</span><span class="k">)</span>
</pre></div>
</div>
<p>Check zfs-dkms package version:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">DKMS_VER</span><span class="o">=</span><span class="k">$(</span>pacman -Si zfs-dkms <span class="se">\</span>
<span class="p">|</span> grep <span class="s1">&#39;Version&#39;</span> <span class="se">\</span>
<span class="p">|</span> awk <span class="s1">&#39;{ print $3 }&#39;</span> <span class="se">\</span>
<span class="p">|</span> sed <span class="s1">&#39;s|-.*||&#39;</span><span class="k">)</span>
</pre></div>
</div>
<p>Visit OpenZFS release page:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>curl -L https://github.com/openzfs/zfs/raw/zfs-<span class="si">${</span><span class="nv">DKMS_VER</span><span class="si">}</span>/META <span class="se">\</span>
<span class="p">|</span> grep Linux
<span class="c1"># Linux-Maximum: 5.10</span>
<span class="c1"># Linux-Minimum: 3.10</span>
<span class="c1"># compare with the output of the following command</span>
<span class="nb">echo</span> <span class="si">${</span><span class="nv">INST_LINVER</span><span class="p">%%-*</span><span class="si">}</span>
<span class="c1"># 5.10.17 # supported</span>
</pre></div>
</div>
<p>If the kernel is supported:</p>
<ul>
<li><p>Install zfs-dkms:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>basestrap <span class="nv">$INST_MNT</span> zfs-dkms <span class="si">${</span><span class="nv">INST_LINVAR</span><span class="si">}</span> <span class="si">${</span><span class="nv">INST_LINVAR</span><span class="si">}</span>-headers
</pre></div>
</div>
</li>
</ul>
<p>If the kernel is not yet supported, install an older kernel:</p>
<ul>
<li><p>Check build date:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">DKMS_DATE</span><span class="o">=</span><span class="k">$(</span>pacman -Syi zfs-dkms <span class="se">\</span>
<span class="p">|</span> grep <span class="s1">&#39;Build Date&#39;</span> <span class="se">\</span>
<span class="p">|</span> sed <span class="s1">&#39;s/.*: //&#39;</span> <span class="se">\</span>
<span class="p">|</span> <span class="nv">LC_ALL</span><span class="o">=</span>C xargs -i<span class="o">{}</span> date -d <span class="o">{}</span> -u +%Y/%m/%d<span class="k">)</span>
</pre></div>
</div>
</li>
<li><p>Check kernel version:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">INST_LINVER</span><span class="o">=</span><span class="k">$(</span>curl https://archive.artixlinux.org/repos/<span class="si">${</span><span class="nv">DKMS_DATE</span><span class="si">}</span>/system/os/x86_64/ <span class="se">\</span>
<span class="p">|</span> grep <span class="se">\&quot;</span><span class="si">${</span><span class="nv">INST_LINVAR</span><span class="si">}</span>-<span class="s1">&#39;[0-9]&#39;</span> <span class="se">\</span>
<span class="p">|</span> grep -v sig <span class="se">\</span>
<span class="p">|</span> sed <span class="s2">&quot;s|.*</span><span class="nv">$INST_LINVAR</span><span class="s2">-||&quot;</span> <span class="se">\</span>
<span class="p">|</span> sed <span class="s2">&quot;s|-x86_64.*||&quot;</span><span class="k">)</span>
</pre></div>
</div>
</li>
<li><p>Install kernel and headers:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>basestrap -U <span class="nv">$INST_MNT</span> <span class="se">\</span>
https://archive.artixlinux.org/packages/l/<span class="si">${</span><span class="nv">INST_LINVAR</span><span class="si">}</span>/<span class="si">${</span><span class="nv">INST_LINVAR</span><span class="si">}</span>-<span class="si">${</span><span class="nv">INST_LINVER</span><span class="si">}</span>-x86_64.pkg.tar.zst <span class="se">\</span>
https://archive.artixlinux.org/packages/l/<span class="si">${</span><span class="nv">INST_LINVAR</span><span class="si">}</span>-headers/<span class="si">${</span><span class="nv">INST_LINVAR</span><span class="si">}</span>-headers-<span class="si">${</span><span class="nv">INST_LINVER</span><span class="si">}</span>-x86_64.pkg.tar.zst
</pre></div>
</div>
</li>
<li><p>Install zfs-dkms:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>basestrap <span class="nv">$INST_MNT</span> zfs-dkms
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>Hold kernel package from updates:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sed -i <span class="s1">&#39;s/#IgnorePkg/IgnorePkg/&#39;</span> <span class="nv">$INST_MNT</span>/etc/pacman.conf
sed -i <span class="s2">&quot;/^IgnorePkg/ s/</span>$<span class="s2">/ </span><span class="si">${</span><span class="nv">INST_LINVAR</span><span class="si">}</span><span class="s2"> </span><span class="si">${</span><span class="nv">INST_LINVAR</span><span class="si">}</span><span class="s2">-headers/&quot;</span> <span class="nv">$INST_MNT</span>/etc/pacman.conf
</pre></div>
</div>
<p>Kernel must be manually updated, see kernel update section in Getting Started.</p>
</li>
<li><p>Install firmware:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>pacstrap <span class="nv">$INST_MNT</span> linux-firmware intel-ucode amd-ucode
</pre></div>
</div>
</li>
<li><p>If you boot your computer with EFI:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>basestrap <span class="nv">$INST_MNT</span> efibootmgr
</pre></div>
</div>
</li>
<li><p>If a swap partition has been created:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>basestrap <span class="nv">$INST_MNT</span> cryptsetup
basestrap <span class="nv">$INST_MNT</span> cryptsetup-openrc
</pre></div>
</div>
</li>
<li><p>For other optional packages,
see <a class="reference external" href="https://wiki.archlinux.org/index.php/Installation_guide#Installation">ArchWiki</a>.</p></li>
</ol>
</div>
</div>
<div class="section" id="system-configuration">
<h2><a class="toc-backref" href="#id16">System Configuration</a><a class="headerlink" href="#system-configuration" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p>Generate fstab:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> bpool_<span class="nv">$INST_UUID</span>/sys/BOOT/default /boot zfs rw,xattr,posixacl <span class="m">0</span> <span class="m">0</span> &gt;&gt; <span class="nv">$INST_MNT</span>/etc/fstab
<span class="nb">echo</span> <span class="nv">UUID</span><span class="o">=</span><span class="k">$(</span>blkid -s UUID -o value <span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>-part1<span class="k">)</span> /boot/efi vfat <span class="nv">umask</span><span class="o">=</span><span class="m">0022</span>,fmask<span class="o">=</span><span class="m">0022</span>,dmask<span class="o">=</span><span class="m">0022</span> <span class="m">0</span> <span class="m">1</span> &gt;&gt; <span class="nv">$INST_MNT</span>/etc/fstab
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">tmpfs</span></code> for <code class="docutils literal notranslate"><span class="pre">/tmp</span></code> is recommended:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s2">&quot;tmpfs /tmp tmpfs nodev,nosuid 0 0&quot;</span> &gt;&gt; <span class="nv">$INST_MNT</span>/etc/fstab
</pre></div>
</div>
<p>If a swap partition has been created:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> /dev/mapper/crypt-swap none swap defaults <span class="m">0</span> <span class="m">0</span> &gt;&gt; <span class="nv">$INST_MNT</span>/etc/fstab
<span class="nb">echo</span> <span class="nv">swap</span><span class="o">=</span>crypt-swap &gt;&gt; <span class="nv">$INST_MNT</span>/etc/conf.d/dmcrypt
<span class="nb">echo</span> <span class="nv">source</span><span class="o">=</span><span class="se">\&#39;</span><span class="si">${</span><span class="nv">DISK</span><span class="si">}</span>-part4<span class="se">\&#39;</span> &gt;&gt; <span class="nv">$INST_MNT</span>/etc/conf.d/dmcrypt
</pre></div>
</div>
</li>
<li><p>Configure mkinitcpio:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mv <span class="nv">$INST_MNT</span>/etc/mkinitcpio.conf <span class="nv">$INST_MNT</span>/etc/mkinitcpio.conf.original

tee <span class="nv">$INST_MNT</span>/etc/mkinitcpio.conf <span class="s">&lt;&lt;EOF</span>
<span class="s">HOOKS=(base udev autodetect modconf block keyboard zfs filesystems)</span>
<span class="s">EOF</span>
</pre></div>
</div>
</li>
<li><p>Host name:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="nv">$INST_HOST</span> &gt; <span class="nv">$INST_MNT</span>/etc/hostname
</pre></div>
</div>
</li>
<li><p>Timezone:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ln -sf <span class="nv">$INST_TZ</span> <span class="nv">$INST_MNT</span>/etc/localtime
hwclock --systohc
</pre></div>
</div>
</li>
<li><p>Locale:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s2">&quot;en_US.UTF-8 UTF-8&quot;</span> &gt;&gt; <span class="nv">$INST_MNT</span>/etc/locale.gen
<span class="nb">echo</span> <span class="s2">&quot;LANG=en_US.UTF-8&quot;</span> &gt;&gt; <span class="nv">$INST_MNT</span>/etc/locale.conf
</pre></div>
</div>
<p>Other locales should be added after reboot.</p>
</li>
<li><p>Chroot:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>artix-chroot <span class="nv">$INST_MNT</span> /usr/bin/env  <span class="nv">DISK</span><span class="o">=</span><span class="nv">$DISK</span> <span class="nv">INST_UUID</span><span class="o">=</span><span class="nv">$INST_UUID</span> bash --login
</pre></div>
</div>
</li>
<li><p>If a swap partition has been created,
enable cryptsetup services for crypt-swap:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>rc-update add device-mapper boot
rc-update add dmcrypt boot
</pre></div>
</div>
</li>
<li><p>Add and enable ZFS mount service:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>tee /etc/init.d/zfs-mount <span class="s">&lt;&lt; &#39;EOF&#39;</span>
<span class="s">#!/usr/bin/openrc-run</span>

<span class="s">start() {</span>
<span class="s">/usr/bin/zfs mount -a</span>
<span class="s">}</span>
<span class="s">EOF</span>

chmod +x /etc/init.d/zfs-mount

rc-update add zfs-mount boot
</pre></div>
</div>
<p>Other ZFS services, such as <code class="docutils literal notranslate"><span class="pre">zed</span></code>
can be ported from <code class="docutils literal notranslate"><span class="pre">/usr/lib/systemd/system/zfs*</span></code>.</p>
</li>
<li><p>Apply locales:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>locale-gen
</pre></div>
</div>
</li>
<li><p>Import keys of archzfs repository:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>curl -L https://archzfs.com/archzfs.gpg <span class="p">|</span>  pacman-key -a -
curl -L https://git.io/JtQpl <span class="p">|</span> xargs -i<span class="o">{}</span> pacman-key --lsign-key <span class="o">{}</span>
</pre></div>
</div>
</li>
<li><p>Add archzfs repository:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>tee -a /etc/pacman.conf <span class="s">&lt;&lt;- &#39;EOF&#39;</span>

<span class="s">[archzfs]</span>
<span class="s">Include = /etc/pacman.d/mirrorlist-archzfs</span>
<span class="s">EOF</span>

curl -L https://git.io/JtQp4 &gt; /etc/pacman.d/mirrorlist-archzfs
</pre></div>
</div>
</li>
<li><p>Enable networking:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>rc-update add connmand default
</pre></div>
</div>
</li>
<li><p>Generate zpool.cache</p>
<p>Pools are imported by initramfs with the information stored in <code class="docutils literal notranslate"><span class="pre">/etc/zfs/zpool.cache</span></code>.
This cache file will be embedded in initramfs.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zpool <span class="nb">set</span> <span class="nv">cachefile</span><span class="o">=</span>/etc/zfs/zpool.cache rpool_<span class="nv">$INST_UUID</span>
zpool <span class="nb">set</span> <span class="nv">cachefile</span><span class="o">=</span>/etc/zfs/zpool.cache bpool_<span class="nv">$INST_UUID</span>
</pre></div>
</div>
</li>
<li><p>Set root password:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>passwd
</pre></div>
</div>
</li>
<li><p>Generate initramfs:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mkinitcpio -P
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="bootloader-installation">
<h2><a class="toc-backref" href="#id17">Bootloader Installation</a><a class="headerlink" href="#bootloader-installation" title="Permalink to this headline">¶</a></h2>
<p>Currently GRUB has multiple compatibility problems with ZFS,
especially with regards to newer ZFS features.
Workarounds have to be applied.</p>
<div class="section" id="grub-probe-fails-to-get-canonical-path">
<h3><a class="toc-backref" href="#id18">grub-probe fails to get canonical path</a><a class="headerlink" href="#grub-probe-fails-to-get-canonical-path" title="Permalink to this headline">¶</a></h3>
<p>When persistent device names <code class="docutils literal notranslate"><span class="pre">/dev/disk/by-id/*</span></code> are used
with ZFS, GRUB will fail to resolve the path of the boot pool
device. Error:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># /usr/bin/grub-probe: error: failed to get canonical path of `/dev/virtio-pci-0000:06:00.0-part3&#39;.</span>
</pre></div>
</div>
<p>Solution:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s1">&#39;export ZPOOL_VDEV_NAME_PATH=YES&#39;</span> &gt;&gt; /etc/profile
<span class="nb">source</span> /etc/profile
</pre></div>
</div>
</div>
<div class="section" id="pool-name-missing">
<h3><a class="toc-backref" href="#id19">Pool name missing</a><a class="headerlink" href="#pool-name-missing" title="Permalink to this headline">¶</a></h3>
<p>See <a class="reference external" href="https://savannah.gnu.org/bugs/?59614">this bug report</a>.
Root pool name is missing from <code class="docutils literal notranslate"><span class="pre">root=ZFS=rpool/ROOT/default</span></code>
in generated <code class="docutils literal notranslate"><span class="pre">grub.cfg</span></code> file.</p>
<p>A workaround is to replace the pool name detection with <code class="docutils literal notranslate"><span class="pre">zdb</span></code>
command:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>sed -i <span class="s2">&quot;s|rpool=.*|rpool=\`zdb -l \${GRUB_DEVICE} \| grep -E &#39;[[:blank:]]name&#39; \| cut -d\\\&#39; -f 2\`|&quot;</span>  /etc/grub.d/10_linux
</pre></div>
</div>
<p>If you forgot to apply this workaround and
followed this guide to use <code class="docutils literal notranslate"><span class="pre">rpool_$INST_UUID</span></code> and <code class="docutils literal notranslate"><span class="pre">bpool_$INST_UUID</span></code>,
<code class="docutils literal notranslate"><span class="pre">$INST_UUID</span></code> can be found out with <a class="reference internal" href="#load-grub-cfg-in-grub-command-line">Load grub.cfg in GRUB command line</a>.</p>
</div>
<div class="section" id="grub-installation">
<h3><a class="toc-backref" href="#id20">GRUB Installation</a><a class="headerlink" href="#grub-installation" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p>If you use EFI:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>grub-install
</pre></div>
</div>
<p>This will only install boot loader to $DISK.
If you use multi-disk setup, other disks are
dealt with later.</p>
<p>Some motherboards does not properly recognize GRUB
boot entry, to ensure that your computer will
boot, also install GRUB to fallback location with:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>grub-install --removable
</pre></div>
</div>
</li>
<li><p>If you use BIOS booting:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>grub-install <span class="nv">$DISK</span>
</pre></div>
</div>
<p>If this is a multi-disk setup,
install to other disks as well:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> i in <span class="o">{</span>target_disk2,target_disk3<span class="o">}</span><span class="p">;</span> <span class="k">do</span>
  grub-install /dev/disk/by-id/<span class="nv">$i</span>
<span class="k">done</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="generate-grub-boot-menu">
<h3><a class="toc-backref" href="#id21">Generate GRUB Boot Menu</a><a class="headerlink" href="#generate-grub-boot-menu" title="Permalink to this headline">¶</a></h3>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>grub-mkconfig -o /boot/grub/grub.cfg
</pre></div>
</div>
</div>
</div>
<div class="section" id="optional-configuration">
<h2><a class="toc-backref" href="#id22">Optional Configuration</a><a class="headerlink" href="#optional-configuration" title="Permalink to this headline">¶</a></h2>
<div class="section" id="supply-password-with-ssh">
<h3><a class="toc-backref" href="#id23">Supply password with SSH</a><a class="headerlink" href="#supply-password-with-ssh" title="Permalink to this headline">¶</a></h3>
<p>Optional:</p>
<ol class="arabic">
<li><p>Install mkinitcpio tools:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>pacman -S mkinitcpio-netconf mkinitcpio-dropbear openssh
</pre></div>
</div>
</li>
<li><p>Store authorized keys in <code class="docutils literal notranslate"><span class="pre">/etc/dropbear/root_key</span></code>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>vi /etc/dropbear/root_key
</pre></div>
</div>
<p>Note that dropbear only supports RSA keys.</p>
</li>
<li><p>Edit mkinitcpio:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>tee /etc/mkinitcpio.conf <span class="s">&lt;&lt;- &#39;EOF&#39;</span>
<span class="s">HOOKS=(base udev autodetect modconf block keyboard netconf dropbear zfsencryptssh zfs filesystems)</span>
<span class="s">EOF</span>
</pre></div>
</div>
</li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">ip=</span></code> to kernel command line:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># example DHCP</span>
<span class="nb">echo</span> <span class="s1">&#39;GRUB_CMDLINE_LINUX=&quot;ip=::::::dhcp&quot;&#39;</span> &gt;&gt; /etc/default/grub
</pre></div>
</div>
<p>Details for <code class="docutils literal notranslate"><span class="pre">ip=</span></code> can be found at
<a class="reference external" href="https://www.kernel.org/doc/html/latest/admin-guide/nfs/nfsroot.html#kernel-command-line">here</a>.</p>
</li>
<li><p>Generate host keys:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ssh-keygen -Am pem
</pre></div>
</div>
</li>
<li><p>Regenerate initramfs:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mkinitcpio -P
</pre></div>
</div>
</li>
<li><p>Update GRUB menu:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>grub-mkconfig -o /boot/grub/grub.cfg
</pre></div>
</div>
</li>
</ol>
</div>
</div>
<div class="section" id="finish-installation">
<h2><a class="toc-backref" href="#id24">Finish Installation</a><a class="headerlink" href="#finish-installation" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p>Exit chroot:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">exit</span>
</pre></div>
</div>
</li>
<li><p>Take a snapshot of the clean installation for future use:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs snapshot -r rpool_<span class="nv">$INST_UUID</span>/sys/ROOT/default@install
zfs snapshot -r bpool_<span class="nv">$INST_UUID</span>/sys/BOOT/default@install
</pre></div>
</div>
</li>
<li><p>Unmount EFI system partition:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>umount <span class="nv">$INST_MNT</span>/boot/efi
</pre></div>
</div>
</li>
<li><p>Export pools:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zpool <span class="nb">export</span> bpool_<span class="nv">$INST_UUID</span>
zpool <span class="nb">export</span> rpool_<span class="nv">$INST_UUID</span>
</pre></div>
</div>
</li>
</ol>
<blockquote>
<div><p>They must be exported, or else they will fail to be imported on reboot.</p>
</div></blockquote>
</div>
<div class="section" id="after-reboot">
<h2><a class="toc-backref" href="#id25">After Reboot</a><a class="headerlink" href="#after-reboot" title="Permalink to this headline">¶</a></h2>
<div class="section" id="mirror-efi-system-partition">
<h3><a class="toc-backref" href="#id26">Mirror EFI System Partition</a><a class="headerlink" href="#mirror-efi-system-partition" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>Check disk name:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ls -1 /dev/disk/by-id/ <span class="p">|</span> grep -v <span class="s1">&#39;\-part[0-9]&#39;</span>
</pre></div>
</div>
</li>
<li><p>Mirror EFI ssystem partition:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> i in <span class="o">{</span>target_disk2,target_disk3<span class="o">}</span><span class="p">;</span> <span class="k">do</span>
 mkfs.vfat /dev/disk/by-id/<span class="nv">$i</span>-part1
 mkdir -p /boot/efis/<span class="nv">$i</span>
 <span class="nb">echo</span> <span class="nv">UUID</span><span class="o">=</span><span class="k">$(</span>blkid -s UUID -o value /dev/disk/by-id/<span class="nv">$i</span>-part1<span class="k">)</span> /boot/efis/<span class="nv">$i</span> vfat <span class="se">\</span>
 <span class="nv">umask</span><span class="o">=</span><span class="m">0022</span>,fmask<span class="o">=</span><span class="m">0022</span>,dmask<span class="o">=</span><span class="m">0022</span> <span class="m">0</span> <span class="m">1</span> &gt;&gt; /etc/fstab
 mount /boot/efis/<span class="nv">$i</span>
 cp -r /boot/efi/EFI/ /boot/efis/<span class="nv">$i</span>
 efibootmgr -cgp <span class="m">1</span> -l <span class="s2">&quot;\EFI\artix\grubx64.efi&quot;</span> <span class="se">\</span>
 -L <span class="s2">&quot;artix-</span><span class="nv">$i</span><span class="s2">&quot;</span> -d /dev/disk/by-id/<span class="nv">$i</span>-part1
<span class="k">done</span>
</pre></div>
</div>
</li>
<li><p>Enable cron and set up cron job to sync EFI system partition contents:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>rc-update add cronie default
crontab -u root -e
<span class="c1"># @hourly /usr/bin/bash -c &#39;for i in /boot/efis/*; do /usr/bin/cp -r /boot/efi/EFI/ $i/; done&#39;</span>
</pre></div>
</div>
<p>Alternatively, monitor <code class="docutils literal notranslate"><span class="pre">/boot/efi/EFI/artix</span></code> with <code class="docutils literal notranslate"><span class="pre">inotifywait</span></code>.</p>
</li>
<li><p>If EFI system partition failed, promote one backup
to <code class="docutils literal notranslate"><span class="pre">/boot/efi</span></code> by editing <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code>.</p></li>
</ol>
</div>
<div class="section" id="mirror-bios-boot-sector">
<h3><a class="toc-backref" href="#id27">Mirror BIOS boot sector</a><a class="headerlink" href="#mirror-bios-boot-sector" title="Permalink to this headline">¶</a></h3>
<p>This need to be manually applied when GRUB is updated.</p>
<ol class="arabic">
<li><p>Check disk name:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ls -1 /dev/disk/by-id/ <span class="p">|</span> grep -v <span class="s1">&#39;\-part[0-9]&#39;</span>
</pre></div>
</div>
</li>
<li><p>Install GRUB to every disk:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> i in <span class="o">{</span>target_disk2,target_disk3<span class="o">}</span><span class="p">;</span> <span class="k">do</span>
  grub-install /dev/disk/by-id/<span class="nv">$i</span>
<span class="k">done</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="boot-environment-manager">
<h3><a class="toc-backref" href="#id28">Boot Environment Manager</a><a class="headerlink" href="#boot-environment-manager" title="Permalink to this headline">¶</a></h3>
<p>Optional: install
<a class="reference external" href="https://gitlab.com/m_zhou/rozb3-pac/-/releases">rozb3-pac</a>
pacman hook and
<a class="reference external" href="https://gitlab.com/m_zhou/bieaz/-/releases">bieaz</a>
from AUR to create boot environments.</p>
<p>Prebuilt packages are also available
in the links above.</p>
</div>
<div class="section" id="post-installation">
<h3><a class="toc-backref" href="#id29">Post installation</a><a class="headerlink" href="#post-installation" title="Permalink to this headline">¶</a></h3>
<p>For post installation recommendations,
see <a class="reference external" href="https://wiki.archlinux.org/index.php/Installation_guide#Post-installation">ArchWiki</a>.</p>
<p>Remember to create separate datasets for individual users.</p>
</div>
</div>
<div class="section" id="recovery">
<h2><a class="toc-backref" href="#id30">Recovery</a><a class="headerlink" href="#recovery" title="Permalink to this headline">¶</a></h2>
<div class="section" id="load-grub-cfg-in-grub-command-line">
<h3><a class="toc-backref" href="#id31">Load grub.cfg in GRUB command line</a><a class="headerlink" href="#load-grub-cfg-in-grub-command-line" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p>Press <code class="docutils literal notranslate"><span class="pre">c</span></code> at GRUB menu.</p></li>
<li><p>List available disks:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>grub &gt; ls <span class="o">(</span>hd <span class="c1"># press tab after &#39;d&#39;</span>
Possible devices are:

hd0 hd1
</pre></div>
</div>
</li>
<li><p>List available boot environments:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>grub &gt; ls <span class="o">(</span>hd0,gpt2<span class="o">)</span>/sys/BOOT <span class="c1"># press tab after &#39;T&#39;</span>
Possible files are:

@/ default/ pac-multm2/
</pre></div>
</div>
</li>
<li><p>Load grub.cfg:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>grub &gt; configfile <span class="o">(</span>hd0,gpt2<span class="o">)</span>/sys/BOOT/default@/grub/grub.cfg
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="rescue-in-live-environment">
<h3><a class="toc-backref" href="#id32">Rescue in Live Environment</a><a class="headerlink" href="#rescue-in-live-environment" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p><a class="reference external" href="#download-artix-linux-live-image">Download Artix Linux live image</a>.</p></li>
<li><p><a class="reference external" href="#prepare-the-live-environment">Prepare the Live Environment</a>.</p></li>
<li><p>Check the <code class="docutils literal notranslate"><span class="pre">INST_UUID</span></code> with <code class="docutils literal notranslate"><span class="pre">zpool</span> <span class="pre">import</span></code>.</p></li>
<li><p>Set variables:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nv">INST_MNT</span><span class="o">=</span><span class="k">$(</span>mktemp -d<span class="k">)</span>
<span class="nv">INST_UUID</span><span class="o">=</span>abc123
</pre></div>
</div>
</li>
<li><p>Import and unlock root and boot pool:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zpool import -N -R <span class="nv">$INST_MNT</span> rpool_<span class="nv">$INST_UUID</span>
zpool import -N -R <span class="nv">$INST_MNT</span> bpool_<span class="nv">$INST_UUID</span>
</pre></div>
</div>
<p>If using password:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs load-key rpool_<span class="nv">$INST_UUID</span>
</pre></div>
</div>
</li>
<li><p>Find the current boot environment:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs list
<span class="nv">BE</span><span class="o">=</span>default
</pre></div>
</div>
</li>
<li><p>Mount root filesystem:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>zfs mount rpool_<span class="nv">$INST_UUID</span>/sys/ROOT/<span class="nv">$BE</span>
</pre></div>
</div>
</li>
<li><p>chroot into the system:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>arch-chroot <span class="nv">$INST_MNT</span> /bin/bash --login
mount /boot
mount /boot/efi
zfs mount -a
</pre></div>
</div>
</li>
<li><p>Finish rescue:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">exit</span>
umount <span class="nv">$INST_MNT</span>/boot/efi
zpool <span class="nb">export</span> bpool_<span class="nv">$INST_UUID</span>
zpool <span class="nb">export</span> rpool_<span class="nv">$INST_UUID</span>
reboot
</pre></div>
</div>
</li>
</ol>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../Debian/index.html" class="btn btn-neutral float-right" title="Debian" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="Arch Linux Root on ZFS.html" class="btn btn-neutral float-left" title="Arch Linux Root on ZFS" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, OpenZFS.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>